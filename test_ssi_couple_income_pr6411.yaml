# Test to demonstrate the issue with PR #6411's approach to SSI couple income
# 
# According to 20 CFR 416.1163 and SSA POMS:
# 1. When both spouses are eligible, their incomes are COMBINED
# 2. The couple's TOTAL countable income is compared to couple FBR
# 3. Each spouse receives HALF of the resulting benefit
#
# PR #6411 incorrectly divides income by 2 BEFORE calculating countable income

- name: SSI eligible couple with earned income - regulatory compliance test
  period: 2024
  input:
    people:
      husband:
        age: 67
        is_ssi_aged: true
        is_tax_unit_head: true
        employment_income: 12_000  # $1,000/month earned income
      wife:
        age: 65
        is_ssi_aged: true
        is_tax_unit_spouse: true
        employment_income: 0
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # Step 1: Verify both are eligible
    is_ssi_aged_blind_disabled: [true, true]
    ssi_marital_both_eligible: [true, true]
    
    # Step 2: Check marital income variables
    # With PR #6411's changes, each gets half the combined income
    ssi_marital_earned_income: [6_000, 6_000]  # PR divides by 2
    
    # Step 3: Check countable income calculation
    # The issue: With divided income, exclusions are applied incorrectly
    # Correct approach (per regulations):
    #   - Combined earned: $12,000
    #   - Apply exclusions to combined: $12,000 - $780 - ($12,000 - $780)/2 = $5,610
    #   - Each spouse's countable income should reflect couple's total: $5,610
    #
    # PR #6411's approach (incorrect):
    #   - Each spouse's earned: $6,000 (divided)
    #   - Apply exclusions individually: $6,000 - $780 - ($6,000 - $780)/2 = $2,610
    #   - This understates countable income!
    
    # We expect this test to show the wrong countable income with PR changes
    ssi_countable_income: [2_610, 2_610]  # Wrong! Should be [5_610, 5_610]

- name: SSI couple benefit calculation - shows underpayment issue
  period: 2024
  input:
    people:
      husband:
        age: 67
        is_ssi_aged: true
        is_tax_unit_head: true
        employment_income: 24_000  # $2,000/month
      wife:
        age: 65
        is_ssi_aged: true  
        is_tax_unit_spouse: true
        employment_income: 0
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # With PR #6411's incorrect approach:
    # - Each spouse gets $12,000 earned income (divided by 2)
    # - Exclusions applied: $12,000 - $780 - ($12,000 - $780)/2 = $5,610 each
    # - Couple FBR for 2024: ~$1,450/month = $17,400/year
    # - Each spouse benefit: ($17,400 - $5,610) / 2 = $5,895
    #
    # Correct approach:
    # - Combined income: $24,000
    # - Exclusions on combined: $24,000 - $780 - ($24,000 - $780)/2 = $11,610
    # - Couple benefit: $17,400 - $11,610 = $5,790
    # - Each spouse: $5,790 / 2 = $2,895
    #
    # The PR gives them MORE benefits than they should get!
    
    ssi_marital_earned_income: [12_000, 12_000]  # PR divides
    ssi_countable_income: [5_610, 5_610]  # Wrong! Should be [11_610, 11_610]
    
    # This will calculate wrong SSI benefits
    # The couple gets overpaid because countable income is understated

- name: Demonstration with unearned income - same issue
  period: 2024
  input:
    people:
      husband:
        age: 67
        is_ssi_aged: true
        is_tax_unit_head: true
        interest_income: 6_000  # Unearned income
      wife:
        age: 65
        is_ssi_aged: true
        is_tax_unit_spouse: true
        interest_income: 0
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # With PR #6411:
    # - Each gets $3,000 unearned (divided by 2)
    # - Exclusion: $3,000 - $240 = $2,760 each
    #
    # Correct:
    # - Combined: $6,000
    # - Exclusion: $6,000 - $240 = $5,760 total
    # - Each should show: $5,760 (the couple's total)
    
    ssi_marital_unearned_income: [3_000, 3_000]  # PR divides
    ssi_countable_income: [2_760, 2_760]  # Wrong! Should be [5_760, 5_760]