# Comprehensive integration tests for Income Security Package with state credits
# Testing that federal CTC/EITC are calculated for state reference but not applied federally

- name: Oklahoma family with all Income Security Package benefits
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  absolute_error_margin: 1
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent1:
        age: 35
        employment_income: 30_000
      parent2:
        age: 33
        employment_income: 20_000
      child1:
        age: 0
        birth_year: 2026  # Newborn eligible for baby bonus
      child2:
        age: 8
        birth_year: 2018
      adult_dependent:
        age: 19
        birth_year: 2007
        is_full_time_student: true
    tax_units:
      tax_unit:
        members: [parent1, parent2, child1, child2, adult_dependent]
        filing_status: JOINT
    households:
      household:
        members: [parent1, parent2, child1, child2, adult_dependent]
        state_code: OK
  output:
    # Federal CTC/EITC are calculated but not included in federal refundable credits
    ctc:
      2026: 4_900  # $2,200 per child + $500 other dependent credit
    eitc:
      2026: 4_225.342  # Joint filers, 2 children, $50k income

    # Oklahoma gets 5% of federal CTC (for state credit)
    ok_child_care_child_tax_credit:
      2026: 245  # 5% of $4,900

    # Oklahoma EITC is 5% of federal EITC (but has special income calculation)
    ok_eitc:
      2026: 72.07  # OK has special calculation for EITC eligible income

    # Income Security Package benefits
    baby_bonus:
      2026: [0, 0, 2_000, 0, 0]  # Only newborn gets bonus

    ecpa_child_benefit:
      2026: [0, 0, 5_630, 5_630, 0]  # Both children under 18

    ecpa_adult_dependent_credit:
      2026: [0, 0, 0, 0, 700]  # Adult dependent gets credit

    ecpa_filer_credit:
      2026: 900  # $1,400 - ($50k - $40k) * 0.05 = $900

    boost_payment:
      2026: [3_000, 3_000, 0, 0, 0]  # $250/month for adults 19-67

    boost_tax:
      2026: 0  # No tax at $50k income (threshold is higher)

    # Verify federal credits are NOT in refundable credits
    income_tax_refundable_credits:
      2026: 1_600  # ECPA filer credit ($900) + adult dependent credit ($700)

- name: Maine single parent with Income Security Package
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  absolute_error_margin: 1
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent:
        age: 28
        employment_income: 25_000
      child1:
        age: 3
        birth_year: 2023
      child2:
        age: 10
        birth_year: 2016
    tax_units:
      tax_unit:
        members: [parent, child1, child2]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [parent, child1, child2]
        state_code: ME
  output:
    # Federal CTC/EITC calculated for state reference
    ctc:
      2026: 4_400  # $2,200 per child
    eitc:
      2026: 7_055.704  # Head of household, 2 children, $25k income

    # Maine EITC is 25% of federal EITC
    me_eitc:
      2026: 1_763.926  # 25% of $7,055.704

    # Income Security Package benefits
    baby_bonus:
      2026: [0, 0, 0]  # No newborns in 2026

    ecpa_child_benefit:
      2026: [0, 5_630, 5_630]  # Both children get benefit

    ecpa_filer_credit:
      2026: 450  # $700 - ($25k - $20k) * 0.05 = $450

    boost_payment:
      2026: [3_000, 0, 0]  # Parent (age 28) gets BOOST payment

    # Federal refundable credits exclude EITC/CTC but include ECPA
    income_tax_refundable_credits:
      2026: 450  # Only ECPA filer credit

- name: Oklahoma family below BOOST tax threshold
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent1:
        age: 40
        employment_income: 80_000
      parent2:
        age: 38
        employment_income: 70_000
      child:
        age: 12
        birth_year: 2014
    tax_units:
      tax_unit:
        members: [parent1, parent2, child]
        filing_status: JOINT
    households:
      household:
        members: [parent1, parent2, child]
        state_code: OK
  output:
    # High income reduces federal CTC
    ctc:
      2026: 2_200  # Full amount at this income

    # Oklahoma still gets 5% of whatever federal CTC is calculated
    ok_child_care_child_tax_credit:
      2026: 0  # Phased out at high income

    # No EITC at this income level
    eitc:
      2026: 0
    ok_eitc:
      2026: 0

    # ECPA benefits
    ecpa_child_benefit:
      2026: [0, 0, 5_630]

    ecpa_filer_credit:
      2026: 0  # Fully phased out at $150k

    # BOOST benefits (phased out at high income)
    boost_payment:
      2026: [3_000, 3_000, 0]  # Reduced at $150k income

    # BOOST tax applies (AGI > threshold for joint filers)
    boost_tax:
      2026: 2_250  # ($150k - $100k) * 0.045

- name: Maine family with disabled adult dependent
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  absolute_error_margin: 1
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent:
        age: 45
        employment_income: 35_000
      child:
        age: 16
        birth_year: 2010
      adult_dependent:
        age: 22
        birth_year: 2004
        is_ssi_disabled: true
    tax_units:
      tax_unit:
        members: [parent, child, adult_dependent]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [parent, child, adult_dependent]
        state_code: ME
  output:
    # Federal calculations
    ctc:
      2026: 2_200  # 1 child under 17 (adult dependent not included in CTC)
    eitc:
      2026: 2_636.632  # Head of household, 1 child, $35k income

    # Maine credits based on federal
    me_eitc:
      2026: 659.158  # 25% of $2,636.632

    # ECPA benefits (replaces federal CTC/EITC)
    ecpa_child_benefit:
      2026: [0, 5_630, 0]  # Child under 18

    ecpa_adult_dependent_credit:
      2026: [0, 0, 0]  # Not a tax unit dependent (age 22)

    ecpa_filer_credit:
      2026: 0  # Phased out at $35k income

    # Federal refundable credits
    income_tax_refundable_credits:
      2026: 0  # No ECPA filer credit (phased out)

- name: Complex Oklahoma family with all benefits
  period: 2027  # Testing uprating
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  absolute_error_margin: 1
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: true
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent1:
        age: 32
        employment_income: 15_000
        self_employment_income: 5_000
      parent2:
        age: 30
        is_ssi_disabled: true
        ssi: 10_000
      newborn:
        age: 0
        birth_year: 2027
      toddler:
        age: 2
        birth_year: 2025
      teenager:
        age: 14
        birth_year: 2013
    tax_units:
      tax_unit:
        members: [parent1, parent2, newborn, toddler, teenager]
        filing_status: JOINT
    households:
      household:
        members: [parent1, parent2, newborn, toddler, teenager]
        state_code: OK
  output:
    # Federal CTC/EITC still calculated
    ctc:
      2027: 6_900  # 3 children, uprated from 2026
    eitc:
      2027: 8_388  # Maximum for 3+ children, low income

    # Oklahoma credits
    ok_child_care_child_tax_credit:
      2027: 345  # 5% of federal CTC
    ok_eitc:
      2027: 333  # OK EITC with special income calculation

    # Income Security Package benefits (uprated for 2027)
    baby_bonus:
      2027: [0, 0, 2_049, 0, 0]  # Only 2027 newborn

    ecpa_child_benefit:
      2027: [0, 0, 5_760, 5_760, 5_760]  # All children, uprated

    ecpa_filer_credit:
      2027: 1_435  # Uprated for 2027

    boost_payment:
      2027: [3_072, 3_072, 0, 0, 0]  # Both parents get BOOST (ages 32 and 30, uprated)

    # No federal EITC/CTC in refundable credits
    income_tax_refundable_credits:
      2027: 1_435  # Only ECPA filer credit