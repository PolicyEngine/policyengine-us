# Tests to ensure ECPA replaces federal EITC/CTC in tax calculations
# while preserving the underlying calculations for state references

- name: Federal EITC calculated but not applied to federal taxes with ECPA
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent:
        age: 30
        employment_income: 15_000
      child:
        age: 5
    tax_units:
      tax_unit:
        members: [parent, child]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [parent, child]
        state_code: CA
  output:
    # ECPA benefits apply
    ecpa_child_benefit:
      2026: [0, 5_630]
    ecpa_filer_credit:
      2026: 700

- name: State that references federal CTC - Oklahoma still gets benefit
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent:
        age: 30
        employment_income: 25_000
      child1:
        age: 5
      child2:
        age: 8
    tax_units:
      tax_unit:
        members: [parent, child1, child2]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [parent, child1, child2]
        state_code: OK
  output:
    # Federal CTC is still calculated for state references
    ctc:
      2026: 4_400  # $2,200 per child at this income
    # Oklahoma gets 5% of federal CTC
    ok_child_care_child_tax_credit:
      2026: 220  # 5% of $4,400
    # ECPA benefits apply instead of federal credits
    ecpa_child_benefit:
      2026: [0, 5_630, 5_630]
    ecpa_filer_credit:
      2026: 450  # 700 - (5000 * 0.05)

- name: Maryland CTC is independent of federal CTC
  period: 2026
  reforms: policyengine_us.reforms.congress.tlaib.income_security_package.income_security_package
  input:
    gov.contrib.congress.tlaib.income_security_package.baby_bonus_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.boost_act.in_effect: false
    gov.contrib.congress.tlaib.income_security_package.end_child_poverty_act.in_effect: true
    people:
      parent:
        age: 28
        employment_income: 18_000
      child1:
        age: 2  # Under 6, qualifies
      child2:
        age: 7  # Over 6, doesn't qualify unless disabled
    tax_units:
      tax_unit:
        members: [parent, child1, child2]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [parent, child1, child2]
        state_code: MD
  output:
    # Federal CTC is still calculated
    ctc:
      2026: 4_400  # $2,200 per child
    # Maryland CTC based on AGI and qualifying children
    # AGI = $18,000, so phase-out = ($18,000 - $15,000) / $1,000 * $50 = $150 per child
    # Child1 (age 2): $500 - $150 = $350
    # Child2 (age 7): not eligible (over 6, not disabled)
    md_ctc:
      2026: 350  # Only for the under-6 child
    # ECPA benefits
    ecpa_child_benefit:
      2026: [0, 5_630, 5_630]
    ecpa_filer_credit:
      2026: 700