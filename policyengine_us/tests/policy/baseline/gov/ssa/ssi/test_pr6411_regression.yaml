# Test demonstrating PR #6411 violates SSI regulations
# According to 20 CFR 416.1163, for eligible couples:
# 1. Income is COMBINED first
# 2. Exclusions are applied to the COMBINED amount
# 3. The couple benefit is calculated
# 4. Each spouse gets HALF the couple benefit
#
# PR #6411 incorrectly divides income BEFORE applying exclusions

- name: PR6411 regression - couple with small earned income
  period: 2024
  input:
    people:
      husband:
        age: 67
        employment_income: 600  # $50/month
      wife:
        age: 65
        employment_income: 0
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # This test will FAIL with PR #6411 changes
    # Correct: Combined $600, less than $780 exclusion, so $0 countable
    # PR #6411: Each gets $300, still less than exclusion, so $0 countable
    # Same result but for wrong reason - process matters for larger amounts
    
    # The issue shows up in intermediate variables:
    # Correct: ssi_marital_earned_income should be [600, 600] (combined)
    # PR #6411: ssi_marital_earned_income is [300, 300] (divided)
    ssi_marital_earned_income: [300, 300]  # With PR changes
    ssi_countable_income: [0, 0]
    ssi: [8_490, 8_490]

- name: PR6411 regression - couple income above exclusion threshold
  period: 2024
  input:
    people:
      husband:
        age: 67
        employment_income: 3_000  # $250/month
      wife:
        age: 65
        employment_income: 0
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # This demonstrates the actual problem:
    # 
    # CORRECT (per regulations):
    # - Combined: $3,000
    # - Exclusions: $3,000 - $780 - ($3,000-$780)/2 = $1,110
    # - Couple benefit: $16,980 - $1,110 = $15,870
    # - Each: $7,935
    #
    # PR #6411 (WRONG):
    # - Each gets: $1,500
    # - Exclusions per person: $1,500 - $780 - ($1,500-$780)/2 = $360
    # - Each benefit: $8,490 - $360 = $8,130
    # - OVERPAYMENT of $195 per person!
    
    ssi_marital_earned_income: [1_500, 1_500]  # Wrong! Should be [3_000, 3_000]
    ssi_countable_income: [360, 360]  # Wrong! Should show couple's combined countable
    ssi: [8_130, 8_130]  # Wrong! Overpaying the couple

- name: PR6411 regression - both spouses earning
  period: 2024
  input:
    people:
      husband:
        age: 67
        employment_income: 1_500
      wife:
        age: 65
        employment_income: 1_500
    marital_units:
      unit:
        members: [husband, wife]
    tax_units:
      unit:
        members: [husband, wife]
    households:
      household:
        members: [husband, wife]
        state_code: CA
  output:
    # This should give SAME result as test 2 (one spouse earning $3,000)
    # because regulations require combining income first
    #
    # But with PR #6411, each already has $1,500
    # So it matches the wrong calculation from test 2
    
    ssi_marital_earned_income: [1_500, 1_500]  # Happens to match their individual amounts
    ssi_countable_income: [360, 360]  # Wrong process, wrong result
    ssi: [8_130, 8_130]  # Overpaying!