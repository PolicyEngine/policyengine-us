# Unit tests for tob_revenue_oasdi
# Tests OASDI trust fund revenue allocation from SS benefit taxation
# Per IRC §86(d)(2): OASDI receives tax on "first 50%" of gross SS benefits
# This means: min(taxable_ss, 50% × gross_ss) goes to OASDI

- name: No SS benefits - zero OASDI revenue
  period: 2024
  input:
    people:
      person1:
        age: 67
        social_security: 0
        employment_income: 100_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    tob_revenue_oasdi: 0

- name: Below threshold - zero OASDI revenue
  period: 2024
  input:
    people:
      person1:
        age: 67
        social_security: 20_000
        employment_income: 10_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Combined income = $10,000 + $10,000 (50% of SS) = $20,000
    # Below single threshold of $25,000 → no taxable SS → no TOB revenue
    tob_revenue_oasdi: 0

- name: Tier 1 only (50% taxable) - all revenue to OASDI
  period: 2024
  absolute_error_margin: 50
  input:
    people:
      person1:
        age: 67
        social_security: 20_000
        employment_income: 20_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Combined income = $20,000 + $10,000 = $30,000 (between $25k and $34k)
    # Taxable SS = min(50% × $20,000, 50% × excess) = $2,500
    # 50% of gross = $10,000
    # OASDI portion = min($2,500, $10,000) = $2,500 (100% to OASDI)
    # HI portion = $0
    taxable_social_security_tier_1: 2_500
    taxable_social_security_tier_2: 0
    # All TOB revenue goes to OASDI when taxable SS ≤ 50% of gross

- name: High income single - 85% taxable with 58.8% OASDI split
  period: 2024
  absolute_error_margin: 100
  input:
    people:
      person1:
        age: 67
        social_security: 30_000
        employment_income: 100_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Taxable SS = 85% × $30,000 = $25,500
    # 50% of gross = $15,000
    # OASDI portion = min($25,500, $15,000) = $15,000
    # OASDI share = $15,000 / $25,500 = 58.8%
    tax_unit_taxable_social_security: 25_500

- name: High income joint - 85% taxable with 58.8% OASDI split
  period: 2024
  absolute_error_margin: 200
  input:
    people:
      person1:
        age: 67
        social_security: 50_000
        employment_income: 150_000
      person2:
        age: 65
    tax_units:
      tax_unit:
        members: [person1, person2]
        filing_status: JOINT
    households:
      household:
        members: [person1, person2]
  output:
    # Taxable SS = 85% × $50,000 = $42,500
    # 50% of gross = $25,000
    # OASDI portion = min($42,500, $25,000) = $25,000
    # OASDI share = $25,000 / $42,500 = 58.8%
    tax_unit_taxable_social_security: 42_500

- name: Moderate income - above tier 2 threshold
  period: 2024
  absolute_error_margin: 100
  input:
    people:
      person1:
        age: 67
        social_security: 24_000
        employment_income: 28_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Combined income = $28,000 + $12,000 (50% of SS) = $40,000
    # Above tier 2 threshold ($34k for single)
    # Tier 1 = min(50% × $24k, 50% × ($34k - $25k)) = min($12k, $4.5k) = $4,500
    # Tier 2 = 85% × ($40k - $34k) = 85% × $6k = $5,100
    # Total taxable = min($4,500 + $5,100, 85% × $24k) = min($9,600, $20,400) = $9,600
    # 50% of gross = $12,000
    # OASDI portion = min($9,600, $12,000) = $9,600 (100% to OASDI)
    # Since taxable SS ($9,600) < 50% of gross ($12,000), all goes to OASDI
    tax_unit_taxable_social_security: 9_600

# Direct unit tests for tob_revenue_oasdi output values
- name: Unit test - OASDI revenue when taxable SS below 50% of gross
  period: 2024
  absolute_error_margin: 10
  input:
    people:
      person1:
        age: 67
        social_security: 20_000
        employment_income: 20_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Taxable SS = $2,500, 50% of gross = $10,000
    # OASDI portion = min($2,500, $10,000) = $2,500 → 100% to OASDI
    # Tax on $2,500 at 10% bracket = $250
    # All TOB revenue goes to OASDI
    tax_unit_taxable_social_security: 2_500
    tob_revenue_oasdi: 250
    tob_revenue_medicare_hi: 0

- name: Unit test - OASDI revenue at 58.8% share (high income)
  period: 2024
  absolute_error_margin: 50
  input:
    people:
      person1:
        age: 67
        social_security: 30_000
        employment_income: 100_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Taxable SS = $25,500 (85% of $30k)
    # 50% of gross = $15,000
    # OASDI share = $15,000 / $25,500 = 58.8%
    # Total TOB = $5,778 (higher marginal rate due to $100k emp income)
    # OASDI = $5,778 × 58.8% = $3,399
    tax_unit_taxable_social_security: 25_500
    tob_revenue_oasdi: 3_399
    tob_revenue_medicare_hi: 2_379
    tob_revenue_total: 5_778

- name: Unit test - OASDI revenue with zero taxable SS
  period: 2024
  input:
    people:
      person1:
        age: 67
        social_security: 15_000
        employment_income: 5_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
  output:
    # Combined income = $5,000 + $7,500 = $12,500 < $25,000 threshold
    # No taxable SS → no TOB revenue
    tax_unit_taxable_social_security: 0
    tob_revenue_oasdi: 0
    tob_revenue_medicare_hi: 0

- name: Unit test - Joint filers OASDI allocation
  period: 2024
  absolute_error_margin: 100
  input:
    people:
      person1:
        age: 68
        social_security: 40_000
        employment_income: 80_000
      person2:
        age: 66
        social_security: 0
    tax_units:
      tax_unit:
        members: [person1, person2]
        filing_status: JOINT
    households:
      household:
        members: [person1, person2]
  output:
    # Combined income = $80,000 + $20,000 (50% of SS) = $100,000
    # Well above joint tier 2 threshold ($44k)
    # Taxable SS = 85% × $40,000 = $34,000
    # 50% of gross = $20,000
    # OASDI share = $20,000 / $34,000 = 58.8%
    tax_unit_taxable_social_security: 34_000
