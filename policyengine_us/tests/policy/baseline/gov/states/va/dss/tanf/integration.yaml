# Virginia TANF Integration Tests
# Tests the full TANF calculation pipeline end-to-end

- name: Group III locality - Single parent family with moderate earned income
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 30
        employment_income_before_lsr: 12_000
        work_hours_per_week: 40
      person2:
        is_child: true
        age: 5
      person3:
        is_child: true
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: VA
        county_str: ARLINGTON_COUNTY_VA
  output:
    # Family size: 3
    # Group III locality (Arlington County)
    #
    # Need standard: $1,017/month * 12 = $12,204/year
    va_tanf_need_standard: 12_204
    #
    # Grant standard: $508/month * 12 = $6,096/year
    va_tanf_grant_standard: 6_096
    #
    # Full-time (40 hours >= 30 hours threshold)
    va_tanf_is_full_time: true
    #
    # Earned income deduction:
    #   Flat exclusion (size 3): $167/month * 12 = $2,004/year
    #   After flat: max($12,000 - $2,004, 0) = $9,996
    #   After 20%: $9,996 * (1 - 0.2) = $7,996.80
    #   After childcare ($4,200): max($7,996.80 - $4,200, 0) = $3,796.80
    va_tanf_countable_earned_income: 3_796.8
    #
    # Childcare deduction (full-time, 2 children age 2+): $175 * 2 * 12 = $4,200/year
    va_tanf_childcare_deduction: 4_200
    #
    # Countable income: $3,796.80 + $0 = $3,796.80
    va_tanf_countable_income: 3_796.8
    #
    # Income eligibility: $3,796.80 <= $12,204? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $6,096 - $3,796.80 = $2,299.20
    # Minimum: $120, Maximum: $8,940
    # $2,299.20 >= $120 and <= $8,940, so benefit = $2,299.20
    va_tanf: 2_299.2

- name: Group II locality - Single parent family with part-time work
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 28
        employment_income_before_lsr: 6_000
        work_hours_per_week: 20
      person2:
        is_child: true
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: VA
        county_str: PITTSYLVANIA_COUNTY_VA
  output:
    # Family size: 2
    # Group II locality (Pittsylvania County)
    #
    # Need standard: $663/month * 12 = $7,956/year
    va_tanf_need_standard: 7_956
    #
    # Grant standard: $332/month * 12 = $3,984/year
    va_tanf_grant_standard: 3_984
    #
    # Part-time (20 hours < 30 hours threshold)
    va_tanf_is_full_time: false
    #
    # Earned income deduction:
    #   Flat exclusion (size 2): $167/month * 12 = $2,004/year
    #   After flat: max($6,000 - $2,004, 0) = $3,996
    #   After 20%: $3,996 * 0.8 = $3,196.80
    #   After childcare ($1,440): max($3,196.80 - $1,440, 0) = $1,756.80
    va_tanf_countable_earned_income: 1_756.8
    #
    # Childcare deduction (part-time, 1 child): $120 * 1 * 12 = $1,440/year
    va_tanf_childcare_deduction: 1_440
    #
    # Countable income: $1,756.80 + $0 = $1,756.80
    va_tanf_countable_income: 1_756.8
    #
    # Income eligibility: $1,756.80 <= $7,956? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $3,984 - $1,756.80 = $2,227.20
    # Minimum: $120, Maximum (Group II): $7,500
    # $2,227.20 >= $120 and <= $7,500, so benefit = $2,227.20
    va_tanf: 2_227.2

- name: TANF-UP scenario - Two able-bodied adults in Group III locality
  period: 2023
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 0
        work_hours_per_week: 0
        is_disabled: false
      person2:
        age: 32
        employment_income_before_lsr: 0
        work_hours_per_week: 0
        is_disabled: false
      person3:
        age: 8
      person4:
        age: 6
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4]
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: VA
        county_str: ARLINGTON_COUNTY_VA
  output:
    # Family size: 4
    # Group III locality (Arlington County)
    # TANF-UP eligible: both parents are able-bodied (not disabled)
    va_up_tanf_eligibility: true
    #
    # Need standard (Group III, size 4): $1,178/month * 12 = $14,136/year
    va_tanf_need_standard: 14_136
    #
    # UP Grant standard (Group III, size 4): $513/month * 12 = $6,156/year
    va_tanf_up_grant_standard: 6_156
    #
    # Part-time (0 hours < 30 hours)
    va_tanf_is_full_time: false
    #
    # No earned income, after childcare deduction still $0
    va_tanf_countable_earned_income: 0
    #
    # Childcare deduction (part-time, 2 children age 2+): $120 * 2 * 12 = $2,880/year
    va_tanf_childcare_deduction: 2_880
    #
    # Countable income: $0 + $0 = $0
    va_tanf_countable_income: 0
    #
    # Income eligibility: $0 <= $14,136? YES
    va_tanf_income_eligibility: true
    #
    # Benefit (TANF-UP): $6,156 - $0 = $6,156
    # Maximum UP (Group III): $648 * 12 = $7,776
    # $6,156 >= $120 and <= $7,776, so benefit = $6,156
    va_tanf: 6_156

- name: Income exceeds need standard - Not eligible
  absolute_error_margin: 0.01
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 35
        employment_income_before_lsr: 30_000
        work_hours_per_week: 40
      person2:
        is_child: true
        age: 10
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: VA
        county_str: ARLINGTON_COUNTY_VA
  output:
    # Family size: 2
    # Group III locality (Arlington County)
    #
    # Need standard: $842/month * 12 = $10,104/year
    va_tanf_need_standard: 10_104
    #
    # Grant standard: $422/month * 12 = $5,064/year
    va_tanf_grant_standard: 5_064
    #
    # Full-time (40 hours >= 30 hours)
    va_tanf_is_full_time: true
    #
    # Earned income deduction:
    #   Flat exclusion (size 2): $167/month * 12 = $2,004/year
    #   After flat: $30,000 - $2,004 = $27,996
    #   After 20%: $27,996 * 0.8 = $22,396.80
    #   After childcare ($2,100): max($22,396.80 - $2,100, 0) = $20,296.80
    va_tanf_countable_earned_income: 20_296.8
    #
    # Childcare deduction (full-time, 1 child age 10): $175 * 12 = $2,100/year
    va_tanf_childcare_deduction: 2_100
    #
    # Countable income: $20,296.80 + $0 = $20,296.80
    va_tanf_countable_income: 20_296.8
    #
    # Income eligibility: $20,296.80 <= $10,104? NO
    va_tanf_income_eligibility: false
    #
    # Not eligible, so benefit = $0
    va_tanf: 0

- name: Group II locality - Family with infant (higher care deduction)
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 25
        employment_income_before_lsr: 7_000
        work_hours_per_week: 35
      person2:
        is_child: true
        age: 1
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: VA
        county_str: PITTSYLVANIA_COUNTY_VA
  output:
    # Family size: 2
    # Group II locality (Pittsylvania County)
    #
    # Need standard: $663/month * 12 = $7,956/year
    va_tanf_need_standard: 7_956
    #
    # Grant standard: $332/month * 12 = $3,984/year
    va_tanf_grant_standard: 3_984
    #
    # Full-time (35 hours >= 30 hours)
    va_tanf_is_full_time: true
    #
    # Earned income deduction:
    #   Flat exclusion (size 2): $167/month * 12 = $2,004/year
    #   After flat: $7,000 - $2,004 = $4,996
    #   After 20%: $4,996 * 0.8 = $3,996.80
    #   After childcare ($2,400): max($3,996.80 - $2,400, 0) = $1,596.80
    va_tanf_countable_earned_income: 1_596.8
    #
    # Childcare deduction (full-time, infant under 2): $200 * 12 = $2,400/year
    va_tanf_childcare_deduction: 2_400
    #
    # Countable income: $1,596.80 + $0 = $1,596.80
    va_tanf_countable_income: 1_596.8
    #
    # Income eligibility:
    #   Step 1: gross_income ($7,000) <= need_standard ($7,956)? YES
    #   Step 2: countable_income ($1,596.80) <= grant_standard ($3,984)? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $3,984 - $1,596.80 = $2,387.20
    # Minimum: $120, Maximum (Group II): $7,500
    # $2,387.20 >= $120 and <= $7,500, so benefit = $2,387.20
    va_tanf: 2_387.2

- name: Family with earned and unearned income (child support)
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 32
        employment_income_before_lsr: 6_000
        work_hours_per_week: 25
        child_support_received: 2_400
      person2:
        is_child: true
        age: 7
      person3:
        is_child: true
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: VA
        county_str: ARLINGTON_COUNTY_VA
  output:
    # Family size: 3
    # Group III locality (Arlington County)
    #
    # Need standard: $1,017/month * 12 = $12,204/year
    va_tanf_need_standard: 12_204
    #
    # Grant standard: $508/month * 12 = $6,096/year
    va_tanf_grant_standard: 6_096
    #
    # Part-time (25 hours < 30 hours threshold)
    va_tanf_is_full_time: false
    #
    # Earned income deduction:
    #   Flat exclusion (size 3): $167/month * 12 = $2,004/year
    #   After flat: max($6,000 - $2,004, 0) = $3,996
    #   After 20%: $3,996 * 0.8 = $3,196.80
    #   After childcare ($2,880): max($3,196.80 - $2,880, 0) = $316.80
    va_tanf_countable_earned_income: 316.8
    #
    # Unearned income:
    #   Child support received: $2,400/year = $200/month
    #   Child support disregard: $100/month * 12 = $1,200/year
    #   Countable child support: $2,400 - $1,200 = $1,200/year
    va_tanf_countable_unearned_income: 1_200
    #
    # Childcare deduction (part-time, 2 children age 2+): $120 * 2 * 12 = $2,880/year
    va_tanf_childcare_deduction: 2_880
    #
    # Countable income: $316.80 + $1,200 = $1,516.80
    va_tanf_countable_income: 1_516.8
    #
    # Income eligibility: $1,516.80 <= $12,204? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $6,096 - $1,516.80 = $4,579.20
    # Minimum: $120, Maximum: $8,940
    # $4,579.20 >= $120 and <= $8,940, so benefit = $4,579.20
    va_tanf: 4_579.2

- name: Large family (size 8) in Group III locality
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 38
        employment_income_before_lsr: 10_000
        work_hours_per_week: 30
      person2:
        is_father: true
        age: 40
        employment_income_before_lsr: 0
        work_hours_per_week: 0
        is_disabled: true
      person3:
        is_child: true
        age: 16
      person4:
        is_child: true
        age: 14
      person5:
        is_child: true
        age: 11
      person6:
        is_child: true
        age: 8
      person7:
        is_child: true
        age: 5
      person8:
        is_child: true
        age: 2
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
        state_code: VA
        county_str: FAIRFAX_COUNTY_VA
  output:
    # Family size: 8
    # Group III locality (Fairfax County)
    #
    # Need standard (size 8): $1,868/month * 12 = $22,416/year
    va_tanf_need_standard: 22_416
    #
    # Grant standard (size 8): $933/month * 12 = $11,196/year
    va_tanf_grant_standard: 11_196
    #
    # Full-time (30 hours >= 30 hours threshold)
    va_tanf_is_full_time: true
    #
    # Earned income deduction:
    #   Flat exclusion (size 8, uses size 6+ rate): $240/month * 12 = $2,880/year
    #   After flat: max($10,000 - $2,880, 0) = $7,120
    #   After 20%: $7,120 * 0.8 = $5,696
    #   After childcare ($14,700): max($5,696 - $14,700, 0) = $0
    va_tanf_countable_earned_income: 0
    #
    # Childcare deduction (full-time):
    #   - 1 disabled adult: $175/month
    #   - 6 children age 2+: $175 * 6 = $1,050/month
    #   Total: ($175 + $1,050) * 12 = $14,700/year
    va_tanf_childcare_deduction: 14_700
    #
    # Countable income: $0 + $0 = $0
    va_tanf_countable_income: 0
    #
    # Income eligibility: $0 <= $22,416? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $11,196 - $0 = $11,196
    # Maximum (Group III): $745 * 12 = $8,940
    # $11,196 > $8,940, so capped at $8,940
    va_tanf: 8_940

- name: Family with disabled adult as care recipient
  period: 2023
  input:
    people:
      person1:
        is_mother: true
        age: 45
        employment_income_before_lsr: 9_000
        work_hours_per_week: 35
      person2:
        is_father: true
        age: 50
        employment_income_before_lsr: 0
        work_hours_per_week: 0
        is_disabled: true
      person3:
        is_child: true
        age: 12
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: VA
        county_str: PITTSYLVANIA_COUNTY_VA
  output:
    # Family size: 3
    # Group II locality (Pittsylvania County)
    #
    # Need standard: $836/month * 12 = $10,032/year
    va_tanf_need_standard: 10_032
    #
    # Grant standard: $417/month * 12 = $5,004/year
    va_tanf_grant_standard: 5_004
    #
    # Full-time (35 hours >= 30 hours threshold)
    va_tanf_is_full_time: true
    #
    # Earned income deduction:
    #   Flat exclusion (size 3): $167/month * 12 = $2,004/year
    #   After flat: max($9,000 - $2,004, 0) = $6,996
    #   After 20%: $6,996 * 0.8 = $5,596.80
    #   After childcare ($4,200): max($5,596.80 - $4,200, 0) = $1,396.80
    va_tanf_countable_earned_income: 1_396.8
    #
    # Childcare deduction (full-time):
    #   - 1 disabled adult age 50 (2+): $175/month
    #   - 1 child age 12 (2+): $175/month
    #   Total: ($175 + $175) * 12 = $4,200/year
    va_tanf_childcare_deduction: 4_200
    #
    # Countable income: $1,396.80 + $0 = $1,396.80
    va_tanf_countable_income: 1_396.8
    #
    # Income eligibility: $1,396.80 <= $10,032? YES
    va_tanf_income_eligibility: true
    #
    # Benefit: $5,004 - $1,396.80 = $3,607.20
    # Minimum: $120, Maximum (Group II): $7,500
    # $3,607.20 >= $120 and <= $7,500, so benefit = $3,607.20
    va_tanf: 3_607.2
