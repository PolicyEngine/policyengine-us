# Integration tests for Oklahoma TANF - full pipeline testing
# Tests realistic family scenarios with complete eligibility and benefit calculations
# OAC 340:10: https://www.law.cornell.edu/regulations/oklahoma/title-340/chapter-10

- name: Scenario 1 - Single parent with 2 children, no income - full benefit
  # Family of 3, no income, receives full payment standard
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 30
        employment_income: 0
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 5
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person3:
        age: 3
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: OK
  output:
    # Family size: 3
    # Gross earned income: $0
    # Countable income: $0
    # Payment standard (family of 3): $292
    # Benefit: $292 - $0 = $292
    ok_tanf_eligible_child: [false, true, true]
    ok_tanf_eligible: true
    ok_tanf_payment_standard: 292
    ok_tanf_countable_income: 0
    ok_tanf: 292

- name: Scenario 2 - Documentation example - family of 3 with $700 earnings
  # From OAC 340:10-3-31.1 example with recipient $240 work expense
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 28
        employment_income: 8_400  # $700/month
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 4  # Under 6, qualifies for $240 work expense
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person3:
        age: 2
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: OK
  output:
    # Family size: 3
    # Monthly gross earned income: $700
    # Work expense deduction (child under 6): $240
    # After work expense: $700 - $240 = $460
    # 50% disregard: $460 * 0.50 = $230
    # Countable earned income: $230
    # Payment standard (family of 3): $292
    # Benefit: $292 - $230 = $62
    ok_tanf_eligible_child: [false, true, true]
    ok_tanf_eligible: true
    ok_tanf_work_expense_deduction: 240
    ok_tanf_countable_income: 230
    ok_tanf_payment_standard: 292
    ok_tanf: 62

- name: Scenario 3 - Single parent with one child, applicant work expense
  # Family of 2, uses $120 applicant work expense (older child)
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 35
        employment_income: 6_000  # $500/month
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 10  # Over 6, so $120 work expense applies
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2]
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: OK
  output:
    # Family size: 2
    # Monthly gross earned income: $500
    # Work expense deduction (applicant): $120
    # After work expense: $500 - $120 = $380
    # 50% disregard: $380 * 0.50 = $190
    # Countable earned income: $190
    # Payment standard (family of 2): $225
    # Benefit: $225 - $190 = $35
    ok_tanf_eligible_child: [false, true]
    ok_tanf_eligible: true
    ok_tanf_work_expense_deduction: 120
    ok_tanf_countable_income: 190
    ok_tanf_payment_standard: 225
    ok_tanf: 35

- name: Scenario 4 - Family of 4 ineligible due to high gross income
  # Gross income exceeds 185% of State Standard of Need
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 40
        employment_income: 18_000  # $1,500/month - exceeds $1,476 limit
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 38
        employment_income: 0
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person3:
        age: 12
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person4:
        age: 8
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4]
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: OK
  output:
    # Family size: 4
    # Monthly gross income: $1,500
    # Max gross income limit (185% of $798): $1,476
    # Income exceeds limit, ineligible
    ok_tanf_eligible_child: [false, false, true, true]
    ok_tanf_income_eligible: false
    ok_tanf_eligible: false
    ok_tanf: 0

- name: Scenario 5 - Family just below income threshold, eligible
  # Gross income just under 185% limit
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 32
        employment_income: 14_280  # $1,190/month - just under $1,193 limit
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 7
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person3:
        age: 5
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: OK
  output:
    # Family size: 3
    # Monthly gross income: $1,190
    # Max gross income limit (185% of $645): $1,193
    # Just under limit, eligible
    # Work expense (child under 6): $240
    # After work expense: $1,190 - $240 = $950
    # 50% disregard: $950 * 0.50 = $475
    # Countable earned income: $475
    # Payment standard: $292
    # Benefit: max($292 - $475, 0) = $0 (but still eligible, just no payment)
    ok_tanf_eligible_child: [false, true, true]
    ok_tanf_income_eligible: true
    ok_tanf_eligible: true
    ok_tanf_countable_income: 475
    ok_tanf: 0

- name: Scenario 6 - Combined earned and unearned income
  # Tests handling of both income types
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 29
        employment_income: 4_800  # $400/month earned
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 4
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2]
        tanf_gross_unearned_income: 1_200  # $100/month unearned
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: OK
  output:
    # Family size: 2
    # Monthly gross earned: $400, unearned: $100
    # Total gross: $500 (under $923 limit)
    # Work expense (child under 6): $240
    # After work expense: max($400 - $240, 0) = $160
    # 50% disregard: $160 * 0.50 = $80
    # Countable earned: $80
    # Countable income: $80 + $100 = $180
    # Payment standard (family of 2): $225
    # Benefit: $225 - $180 = $45
    ok_tanf_eligible_child: [false, true]
    ok_tanf_eligible: true
    ok_tanf_countable_income: 180
    ok_tanf_payment_standard: 225
    ok_tanf: 45

- name: Scenario 7 - Large family of 5, partial benefit
  # Tests larger family size payment standard
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 38
        employment_income: 9_600  # $800/month
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person2:
        age: 36
        employment_income: 0
        is_tax_unit_head_or_spouse: true
        immigration_status: CITIZEN
      person3:
        age: 14
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person4:
        age: 10
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
      person5:
        age: 5
        employment_income: 0
        is_tax_unit_dependent: true
        immigration_status: CITIZEN
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5]
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4, person5]
    households:
      household:
        members: [person1, person2, person3, person4, person5]
        state_code: OK
  output:
    # Family size: 5
    # Monthly gross income: $800
    # Max gross income limit (185% of $933): $1,726
    # Under limit, eligible
    # Work expense (child under 6): $240
    # After work expense: $800 - $240 = $560
    # 50% disregard: $560 * 0.50 = $280
    # Countable earned: $280
    # Payment standard (family of 5): $422
    # Benefit: $422 - $280 = $142
    ok_tanf_eligible_child: [false, false, true, true, true]
    ok_tanf_income_eligible: true
    ok_tanf_eligible: true
    ok_tanf_work_expense_deduction: 240
    ok_tanf_countable_income: 280
    ok_tanf_payment_standard: 422
    ok_tanf: 142
