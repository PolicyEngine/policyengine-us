# Tests for Oklahoma pension subtraction (Line 6 on Schedule 511-A)
# The limit changed from $10,000 to $20,000 per person effective 2024 (HB 2020)

- name: OK pension subtraction - 2021 - both at limit ($10,000)
  absolute_error_margin: 0.01
  period: 2021
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 68
        taxable_pension_income: 20_000
      person2:
        is_tax_unit_spouse: true
        age: 66
        taxable_pension_income: 9_000
    spm_units:
      spm_unit:
        members: [person1, person2]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1, person2]
        aca_ptc: 0
    households:
      household:
        members: [person1, person2]
        state_code: OK
  output:
    # Person1: $20,000 pension, capped at $10,000 limit
    # Person2: $9,000 pension, under $10,000 limit = $9,000
    # Total: $10,000 + $9,000 = $19,000
    ok_pension_subtraction: 10_000 + 9_000

- name: OK pension subtraction - 2023 - under old $10,000 limit
  absolute_error_margin: 0.01
  period: 2023
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 65
        taxable_pension_income: 8_000
    spm_units:
      spm_unit:
        members: [person1]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1]
        aca_ptc: 0
    households:
      household:
        members: [person1]
        state_code: OK
  output:
    # Person: $8,000 pension, under $10,000 limit = $8,000
    ok_pension_subtraction: 8_000

- name: OK pension subtraction - 2023 - over old $10,000 limit (capped)
  absolute_error_margin: 0.01
  period: 2023
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 70
        taxable_pension_income: 25_000
    spm_units:
      spm_unit:
        members: [person1]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1]
        aca_ptc: 0
    households:
      household:
        members: [person1]
        state_code: OK
  output:
    # Person: $25,000 pension, capped at $10,000 limit
    ok_pension_subtraction: 10_000

- name: OK pension subtraction - 2024 - under new $20,000 limit
  absolute_error_margin: 0.01
  period: 2024
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 66
        taxable_pension_income: 15_000
    spm_units:
      spm_unit:
        members: [person1]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1]
        aca_ptc: 0
    households:
      household:
        members: [person1]
        state_code: OK
  output:
    # Person: $15,000 pension, under new $20,000 limit = $15,000
    # This test validates HB 2020 - pension limit increased to $20,000
    ok_pension_subtraction: 15_000

- name: OK pension subtraction - 2024 - at new $20,000 limit
  absolute_error_margin: 0.01
  period: 2024
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 68
        taxable_pension_income: 20_000
    spm_units:
      spm_unit:
        members: [person1]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1]
        aca_ptc: 0
    households:
      household:
        members: [person1]
        state_code: OK
  output:
    # Person: $20,000 pension, exactly at new $20,000 limit = $20,000
    ok_pension_subtraction: 20_000

- name: OK pension subtraction - 2024 - over new $20,000 limit (capped)
  absolute_error_margin: 0.01
  period: 2024
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 72
        taxable_pension_income: 35_000
    spm_units:
      spm_unit:
        members: [person1]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1]
        aca_ptc: 0
    households:
      household:
        members: [person1]
        state_code: OK
  output:
    # Person: $35,000 pension, capped at new $20,000 limit
    ok_pension_subtraction: 20_000

- name: OK pension subtraction - 2025 - married couple with new limits
  absolute_error_margin: 0.01
  period: 2025
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 68
        taxable_pension_income: 30_000
      person2:
        is_tax_unit_spouse: true
        age: 66
        taxable_pension_income: 18_000
    spm_units:
      spm_unit:
        members: [person1, person2]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1, person2]
        aca_ptc: 0
    households:
      household:
        members: [person1, person2]
        state_code: OK
  output:
    # Person1: $30,000 pension, capped at $20,000 limit
    # Person2: $18,000 pension, under $20,000 limit = $18,000
    # Total: $20,000 + $18,000 = $38,000
    ok_pension_subtraction: 20_000 + 18_000

- name: OK pension subtraction - 2025 - both spouses over limit
  absolute_error_margin: 0.01
  period: 2025
  input:
    people:
      person1:
        is_tax_unit_head: true
        age: 70
        taxable_pension_income: 50_000
      person2:
        is_tax_unit_spouse: true
        age: 68
        taxable_pension_income: 45_000
    spm_units:
      spm_unit:
        members: [person1, person2]
        snap: 0
        tanf: 0
    tax_units:
      tax_unit:
        members: [person1, person2]
        aca_ptc: 0
    households:
      household:
        members: [person1, person2]
        state_code: OK
  output:
    # Person1: $50,000 pension, capped at $20,000 limit
    # Person2: $45,000 pension, capped at $20,000 limit
    # Total: $20,000 + $20,000 = $40,000
    ok_pension_subtraction: 40_000
