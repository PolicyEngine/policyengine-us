# Integration tests for Iowa FIP (Family Investment Program) - full pipeline testing
# Tests realistic family scenarios with complete eligibility and benefit calculations
# Reference: https://www.legis.iowa.gov/docs/iac/chapter/01-07-2026.441.41.pdf
#
# Key Iowa FIP rules:
# - 20% earned income deduction
# - 58% work incentive disregard (applied after 20% deduction)
# - Gross income limit: 185% of standard of need
# - Net income test (applicants only): net income < standard of need
# - Payment standard test: countable income < payment standard
# - Payment standard ~ 50.18% of standard of need
# - Resource limits: $2,000 applicants, $5,000 recipients

- name: Scenario 1, single parent with 2 children, no income - full benefit.
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent:
        age: 30
        employment_income_before_lsr: 0
      child1:
        age: 5
      child2:
        age: 3
    spm_units:
      spm_unit:
        members: [parent, child1, child2]
    tax_units:
      tax_unit:
        members: [parent, child1, child2]
    households:
      household:
        members: [parent, child1, child2]
        state_code: IA
  output:
    # Family of 3
    # Standard of need: $849, Payment standard: $426
    ia_fip_standard_of_need: 849
    ia_fip_payment_standard: 426
    # No income - all tests pass
    ia_fip_gross_income: 0
    ia_fip_countable_income: 0
    ia_fip_income_eligible: true
    ia_fip_eligible: true
    # Benefit: $426 - $0 = $426
    ia_fip: 426

- name: Scenario 2, single parent with 1 child, $800/month earnings.
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent:
        age: 28
        employment_income_before_lsr: 9_600  # $800/month * 12
      child1:
        age: 4
    spm_units:
      spm_unit:
        members: [parent, child1]
    tax_units:
      tax_unit:
        members: [parent, child1]
    households:
      household:
        members: [parent, child1]
        state_code: IA
  output:
    # Family of 2
    # Standard of need: $719, Payment standard: $361
    ia_fip_standard_of_need: 719
    ia_fip_payment_standard: 361
    # Gross income: $800
    ia_fip_gross_income: 800
    # Test 1: $800 <= $719 * 1.85 = $1,330.15 -> pass
    # Test 2: $800 - ($800 * 0.20) = $640 < $719 -> pass
    # Test 3: 20% deduction: $800 * 0.20 = $160
    #   Remaining: $640, 58% disregard: $640 * 0.58 = $371.20
    #   Countable earned: $640 - $371.20 = $268.80
    ia_fip_countable_earned_income: 269
    ia_fip_countable_income: 269
    # $269 < $361 -> pass
    ia_fip_income_eligible: true
    ia_fip_eligible: true
    # Benefit: $361 - $269 = $92
    ia_fip: 92

- name: Scenario 3, family of 4 with mixed income.
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent:
        age: 35
        employment_income_before_lsr: 7_200  # $600/month * 12
        social_security: 2_400  # $200/month * 12
      child1:
        age: 10
      child2:
        age: 7
      child3:
        age: 3
    spm_units:
      spm_unit:
        members: [parent, child1, child2, child3]
    tax_units:
      tax_unit:
        members: [parent, child1, child2, child3]
    households:
      household:
        members: [parent, child1, child2, child3]
        state_code: IA
  output:
    # Family of 4
    # Standard of need: $986, Payment standard: $495
    ia_fip_standard_of_need: 986
    ia_fip_payment_standard: 495
    # Gross income: $600 + $200 = $800
    ia_fip_gross_income: 800
    # Test 1: $800 <= $986 * 1.85 = $1,824.10 -> pass
    # Test 2: $800 - ($600 * 0.20) = $800 - $120 = $680 < $986 -> pass
    # Test 3: 20% deduction on earned: $600 * 0.20 = $120
    #   Remaining earned: $480, 58% disregard: $480 * 0.58 = $278.40
    #   Countable earned: $480 - $278.40 = $201.60
    #   Countable income: $201.60 + $200 = $401.60
    ia_fip_countable_earned_income: 202
    ia_fip_countable_income: 402
    # $402 < $495 -> pass
    ia_fip_income_eligible: true
    ia_fip_eligible: true
    # Benefit: $495 - $402 = $93
    ia_fip: 93

- name: Scenario 4, income exceeds payment standard - ineligible.
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent:
        age: 32
        employment_income_before_lsr: 18_000  # $1,500/month * 12
      child1:
        age: 6
    spm_units:
      spm_unit:
        members: [parent, child1]
    tax_units:
      tax_unit:
        members: [parent, child1]
    households:
      household:
        members: [parent, child1]
        state_code: IA
  output:
    # Family of 2
    # Standard of need: $719, Payment standard: $361
    ia_fip_standard_of_need: 719
    ia_fip_payment_standard: 361
    # Gross income: $1,500
    # Test 1: $1,500 > $719 * 1.85 = $1,330.15 -> FAIL
    ia_fip_gross_income: 1_500
    ia_fip_income_eligible: false
    ia_fip_eligible: false
    ia_fip: 0

- name: Scenario 5, passes gross test but fails net income test (applicant).
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent:
        age: 30
        employment_income_before_lsr: 1_200  # $100/month * 12
        social_security: 7_200  # $600/month * 12
      child1:
        age: 8
    spm_units:
      spm_unit:
        members: [parent, child1]
    tax_units:
      tax_unit:
        members: [parent, child1]
    households:
      household:
        members: [parent, child1]
        state_code: IA
  output:
    # Family of 2
    # Standard of need: $719, Payment standard: $361
    ia_fip_standard_of_need: 719
    ia_fip_payment_standard: 361
    # Gross income: $100 + $600 = $700
    ia_fip_gross_income: 700
    # Test 1: $700 <= $1,330.15 -> pass
    # Test 2 (applicant): net = $700 - ($100 * 0.20) = $680
    #   $680 < $719 -> pass
    # Test 3: earned after deductions: $100 * 0.80 = $80
    #   58% disregard: $80 * 0.58 = $46.40
    #   Countable earned: $80 - $46.40 = $33.60
    #   Countable: $33.60 + $600 = $633.60
    ia_fip_countable_income: 634
    # $634 > $361 -> FAIL payment standard test
    ia_fip_income_eligible: false
    ia_fip_eligible: false
    ia_fip: 0

- name: Scenario 6, single parent, no children - ineligible (no TANF demographics).
  period: 2025-01
  input:
    people:
      person1:
        age: 25
        employment_income_before_lsr: 0
    spm_units:
      spm_unit:
        members: [person1]
    tax_units:
      tax_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: IA
  output:
    ia_fip_eligible: false
    ia_fip: 0

- name: Scenario 7, non-Iowa state returns zero.
  period: 2025-01
  input:
    people:
      parent:
        age: 30
        employment_income_before_lsr: 0
      child1:
        age: 5
    spm_units:
      spm_unit:
        members: [parent, child1]
    tax_units:
      tax_unit:
        members: [parent, child1]
    households:
      household:
        members: [parent, child1]
        state_code: IL
  output:
    ia_fip_eligible: false
    ia_fip: 0

- name: Scenario 8, large family of 6, low income - eligible.
  period: 2025-01
  absolute_error_margin: 1
  input:
    people:
      parent1:
        age: 35
        employment_income_before_lsr: 6_000  # $500/month * 12
      parent2:
        age: 33
        employment_income_before_lsr: 0
      child1:
        age: 12
      child2:
        age: 9
      child3:
        age: 6
      child4:
        age: 2
    spm_units:
      spm_unit:
        members: [parent1, parent2, child1, child2, child3, child4]
    tax_units:
      tax_unit:
        members: [parent1, parent2, child1, child2, child3, child4]
    households:
      household:
        members: [parent1, parent2, child1, child2, child3, child4]
        state_code: IA
  output:
    # Family of 6
    # Standard of need: $1,216, Payment standard: $610
    ia_fip_standard_of_need: 1_216
    ia_fip_payment_standard: 610
    # Gross: $500
    ia_fip_gross_income: 500
    # Test 1: $500 <= $1,216 * 1.85 = $2,249.60 -> pass
    # Test 2: $500 - ($500 * 0.20) = $400 < $1,216 -> pass
    # Test 3: 20% deduction: $500 * 0.20 = $100
    #   Remaining: $400, 58% disregard: $400 * 0.58 = $232
    #   Countable earned: $400 - $232 = $168
    ia_fip_countable_earned_income: 168
    ia_fip_countable_income: 168
    # $168 < $610 -> pass
    ia_fip_income_eligible: true
    ia_fip_eligible: true
    # Benefit: $610 - $168 = $442
    ia_fip: 442
