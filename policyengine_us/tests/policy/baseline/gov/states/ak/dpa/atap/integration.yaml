# Integration tests for Alaska ATAP - full pipeline testing
# Tests realistic family scenarios with complete eligibility and benefit calculations
# 7 AAC 45: https://www.law.cornell.edu/regulations/alaska/title-7/part-3/chapter-45
# Adult-included only (minimum family size 2)
# Work incentive: $150 flat + 33% for continuing, $90 for new applicants
# Child support passthrough: first $50 not counted
# Benefit = (Need Standard - Countable Income) * (Max Payment / Need Standard)

- name: Single parent with 2 children, $800 earned income (continuing)
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 30
        employment_income_before_lsr: 9_600  # $800/month
      child1:
        age: 8
      child2:
        age: 5
    spm_units:
      spm_unit:
        members: [adult, child1, child2]
        is_tanf_enrolled: true
    tax_units:
      tax_unit:
        members: [adult, child1, child2]
    households:
      household:
        members: [adult, child1, child2]
        state_code: AK
  output:
    # Family size 3: 185% limit = $3,975, need = $2,149, max = $923
    # Gross $800 < $3,975 ✓
    # Earned deduction: $150 + ($800-$150)*0.33 = $150 + $214.50 = $364.50
    # Countable earned: $800 - $364.50 = $435.50
    # Countable < $2,149 ✓
    # Benefit: ($2,149 - $435.50) * ($923 / $2,149) = $1,713.50 * 0.4295 = $735.85
    ak_atap_gross_income_limit: 3_975
    ak_atap_need_standard: 2_149
    ak_atap_maximum_payment: 923
    ak_atap_countable_earned_income: 435.50
    ak_atap_gross_income_eligible: true
    ak_atap_net_income_eligible: true
    ak_atap_eligible: true
    ak_atap: 735

- name: Single parent with 1 child, over 185% limit
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 28
        employment_income_before_lsr: 48_000  # $4,000/month
      child1:
        age: 4
    spm_units:
      spm_unit:
        members: [adult, child1]
    tax_units:
      tax_unit:
        members: [adult, child1]
    households:
      household:
        members: [adult, child1]
        state_code: AK
  output:
    # Family size 2: 185% limit = $3,529
    # Gross $4,000 > $3,529 = INELIGIBLE
    ak_atap_gross_income_limit: 3_529
    ak_atap_gross_income_eligible: false
    ak_atap_eligible: false
    ak_atap: 0

- name: Single parent with 1 child, zero income
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 25
        employment_income_before_lsr: 0
      child1:
        age: 3
    spm_units:
      spm_unit:
        members: [adult, child1]
    tax_units:
      tax_unit:
        members: [adult, child1]
    households:
      household:
        members: [adult, child1]
        state_code: AK
  output:
    # Family size 2: need = $1,908, max = $821
    # Zero income = full benefit
    # Benefit: ($1,908 - $0) * ($821 / $1,908) = $821
    ak_atap_need_standard: 1_908
    ak_atap_maximum_payment: 821
    ak_atap_countable_income: 0
    ak_atap_eligible: true
    ak_atap: 821

- name: Family with earned and child support income
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 29
        employment_income_before_lsr: 4_800  # $400/month
        child_support_received: 1_200  # $100/month
      child1:
        age: 6
      child2:
        age: 4
    spm_units:
      spm_unit:
        members: [adult, child1, child2]
        is_tanf_enrolled: true
    tax_units:
      tax_unit:
        members: [adult, child1, child2]
    households:
      household:
        members: [adult, child1, child2]
        state_code: AK
  output:
    # Family size 3: need = $2,149, max = $923
    # Earned deduction: $150 + ($400-$150)*0.33 = $232.50
    # Countable earned: $400 - $232.50 = $167.50
    # Child support: $100 - $50 passthrough = $50 countable
    # Total countable: $167.50 + $50 = $217.50
    # Benefit: ($2,149 - $217.50) * ($923 / $2,149) = $829.82
    ak_atap_countable_earned_income: 167.50
    ak_atap_countable_unearned_income: 50
    ak_atap_countable_income: 217.50
    ak_atap_eligible: true
    ak_atap: 829

- name: New applicant (lower deduction)
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 30
        employment_income_before_lsr: 6_000  # $500/month
      child1:
        age: 5
    spm_units:
      spm_unit:
        members: [adult, child1]
        is_tanf_enrolled: false  # New applicant
    tax_units:
      tax_unit:
        members: [adult, child1]
    households:
      household:
        members: [adult, child1]
        state_code: AK
  output:
    # Family size 2: need = $1,908, max = $821
    # New applicant: only $90 flat deduction
    # Countable earned: $500 - $90 = $410
    # Benefit: ($1,908 - $410) * ($821 / $1,908) = $644.57
    ak_atap_countable_earned_income: 410
    ak_atap_eligible: true
    ak_atap: 644

- name: Large family (size 10)
  period: 2026-01
  absolute_error_margin: 1
  input:
    people:
      adult:
        age: 40
        employment_income_before_lsr: 0
      child1:
        age: 17
      child2:
        age: 15
      child3:
        age: 13
      child4:
        age: 11
      child5:
        age: 9
      child6:
        age: 7
      child7:
        age: 5
      child8:
        age: 3
      child9:
        age: 1
    spm_units:
      spm_unit:
        members: [adult, child1, child2, child3, child4, child5, child6, child7, child8, child9]
    tax_units:
      tax_unit:
        members: [adult, child1, child2, child3, child4, child5, child6, child7, child8, child9]
    households:
      household:
        members: [adult, child1, child2, child3, child4, child5, child6, child7, child8, child9]
        state_code: AK
  output:
    # Family size 10: need = $3,835, max = $1,637
    # Zero income = full benefit = $1,637
    ak_atap_need_standard: 3_835
    ak_atap_maximum_payment: 1_637
    ak_atap_eligible: true
    ak_atap: 1_637
