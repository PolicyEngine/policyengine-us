# Edge case tests for Alaska ATAP
# Auto-generated to cover boundary conditions, extreme values, and error cases
# Coverage: Deduction calculations, income thresholds, family size limits, minimum payment

#############################################
# Earned Income Deduction Edge Cases
# Tests ak_atap_earned_income_deduction.py
#############################################

- name: Edge 1, zero gross income produces zero deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Zero income = zero deduction
    # Flat deduction applies to gross, but max_(0 - 150, 0) = 0
    # So deduction = 150 + 0 * 0.33 = 150
    # But wait, the actual deduction cannot exceed gross income
    # Formula: flat_deduction + percent_disregard
    # flat_deduction = 150, after_flat = max(0-150,0) = 0
    # percent_disregard = 0 * 0.33 = 0
    # Total deduction = 150 + 0 = 150 (but this is the DEDUCTION claimed, not applied)
    ak_atap_earned_income_deduction: 150

- name: Edge 2, income $1 produces deduction capped at gross.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12  # $1/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross: $1, flat: $150
    # after_flat = max(1 - 150, 0) = 0
    # percent_disregard = 0 * 0.33 = 0
    # Total deduction = 150 + 0 = 150
    ak_atap_earned_income_deduction: 150

- name: Edge 3, income $151 just above flat deduction.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_812  # $151/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross: $151, flat: $150
    # after_flat = 151 - 150 = 1
    # percent_disregard = 1 * 0.33 = 0.33
    # Total deduction = 150 + 0.33 = 150.33
    ak_atap_earned_income_deduction: 150.33

#############################################
# Countable Earned Income Edge Cases
# Tests ak_atap_countable_earned_income.py
#############################################

- name: Edge 4, countable income floors to zero when deduction exceeds gross.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_200  # $100/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross: $100, deduction: $150
    # Countable = max(100 - 150, 0) = 0
    ak_atap_countable_earned_income: 0

- name: Edge 5, countable income $1 when deduction is $1 less than gross.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_812  # $151/month = $150 + $1
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross: $151, flat: $150
    # after_flat = 1, percent_disregard = 0.33
    # deduction = 150.33
    # Countable = max(151 - 150.33, 0) = 0.67
    ak_atap_countable_earned_income: 0.67

#############################################
# Countable Unearned Income Edge Cases
# Tests ak_atap_countable_unearned_income.py
#############################################

- name: Edge 6, child support exactly $50 passthrough results in zero countable.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 600  # $50/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Child support $50, passthrough $50
    # Countable = max(50 - 50, 0) = 0
    ak_atap_countable_unearned_income: 0

- name: Edge 7, child support $0 has no passthrough effect.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 0
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # No child support = no countable
    ak_atap_countable_unearned_income: 0

- name: Edge 8, child support $51 results in $1 countable.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 612  # $51/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Child support $51, passthrough $50
    # Countable = 51 - 50 = 1
    ak_atap_countable_unearned_income: 1

- name: Edge 9, large child support $500 over passthrough.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 6_000  # $500/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Child support $500, passthrough $50
    # Countable = 500 - 50 = 450
    ak_atap_countable_unearned_income: 450

#############################################
# Need Standard / Gross Income Limit Edge Cases
# Tests size capping behavior at max sizes
#############################################

- name: Edge 10, adult-included size 11 at max cap.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
      person2:
        age: 17
      person3:
        age: 15
      person4:
        age: 13
      person5:
        age: 11
      person6:
        age: 9
      person7:
        age: 7
      person8:
        age: 5
      person9:
        age: 3
      person10:
        age: 2
      person11:
        age: 1
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11]
        ak_atap_is_child_only_unit: false
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11]
        state_code: AK
  output:
    # Size 11 adult-included = max cap
    # Need standard size 11: $1,741
    ak_atap_need_standard: 1_741

- name: Edge 11, adult-included size 12 exceeds cap uses size 11 value.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
      person2:
        age: 17
      person3:
        age: 15
      person4:
        age: 13
      person5:
        age: 11
      person6:
        age: 9
      person7:
        age: 7
      person8:
        age: 5
      person9:
        age: 3
      person10:
        age: 2
      person11:
        age: 1
      person12:
        age: 0
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11, person12]
        ak_atap_is_child_only_unit: false
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11, person12]
        state_code: AK
  output:
    # Size 12 clips to 11, uses size 11 values
    # Need standard: $1,741
    ak_atap_need_standard: 1_741

- name: Edge 12, child-only size 4 at max cap.
  period: 2024-01
  input:
    people:
      person1:
        age: 12
      person2:
        age: 10
      person3:
        age: 8
      person4:
        age: 6
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
        ak_atap_is_child_only_unit: true
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: AK
  output:
    # Child-only size 4 = max cap
    # Need standard: $868
    ak_atap_need_standard: 868

- name: Edge 13, child-only size 5 exceeds cap uses size 4 value.
  period: 2024-01
  input:
    people:
      person1:
        age: 14
      person2:
        age: 12
      person3:
        age: 10
      person4:
        age: 8
      person5:
        age: 6
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5]
        ak_atap_is_child_only_unit: true
    households:
      household:
        members: [person1, person2, person3, person4, person5]
        state_code: AK
  output:
    # Size 5 clips to 4, uses size 4 values
    # Need standard: $868
    ak_atap_need_standard: 868

#############################################
# Minimum Payment Threshold Edge Cases
# Tests $10 minimum payment rule in ak_atap.py
#############################################

- name: Edge 14, benefit exactly $10 is issued.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_eligible: true
        ak_atap_need_standard: 823
        ak_atap_countable_income: 812
        ak_atap_maximum_payment: 821
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Need: $823, Countable: $812, Deficit: $11
    # Payment: floor($11 * $821 / $823) = floor(10.97) = $10
    # $10 >= $10 minimum, so benefit IS issued
    ak_atap: 10

- name: Edge 15, benefit $9 is below minimum not issued.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_eligible: true
        ak_atap_need_standard: 823
        ak_atap_countable_income: 814
        ak_atap_maximum_payment: 821
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Need: $823, Countable: $814, Deficit: $9
    # Payment: floor($9 * $821 / $823) = floor(8.98) = $8
    # $8 < $10 minimum, so benefit NOT issued
    ak_atap: 0

- name: Edge 16, benefit $11 just above minimum is issued.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_eligible: true
        ak_atap_need_standard: 823
        ak_atap_countable_income: 811
        ak_atap_maximum_payment: 821
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Need: $823, Countable: $811, Deficit: $12
    # Payment: floor($12 * $821 / $823) = floor(11.97) = $11
    # $11 >= $10 minimum, so benefit IS issued
    ak_atap: 11

#############################################
# Net Income Eligibility Edge Cases
# Tests income at/above need standard
#############################################

- name: Edge 17, countable income exactly at need standard gives zero benefit.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_eligible: true
        ak_atap_need_standard: 823
        ak_atap_countable_income: 823
        ak_atap_maximum_payment: 821
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Need: $823, Countable: $823, Deficit: $0
    # Payment: $0 * ratio = $0
    ak_atap: 0

- name: Edge 18, countable income $1 above need standard makes ineligible.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_need_standard: 823
        ak_atap_countable_income: 824
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Countable $824 > Need $823, so net income ineligible
    ak_atap_net_income_eligible: false

- name: Edge 19, countable income $1 below need standard is eligible.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        ak_atap_need_standard: 823
        ak_atap_countable_income: 822
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Countable $822 <= Need $823, so net income eligible
    ak_atap_net_income_eligible: true

#############################################
# Gross Income Eligibility Edge Cases
# Tests gross income at 185% threshold
#############################################

- name: Edge 20, gross income exactly at 185% limit is eligible.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 18_264  # $1,522/month = exactly at limit
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross $1,522 = Limit $1,522, so <= passes
    ak_atap_gross_income_eligible: true

- name: Edge 21, gross income $1 above 185% limit is ineligible.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 18_276  # $1,523/month = $1 over limit
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross $1,523 > Limit $1,522, so fails
    ak_atap_gross_income_eligible: false

- name: Edge 22, gross income $1 below 185% limit is eligible.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 18_252  # $1,521/month = $1 under limit
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Gross $1,521 < Limit $1,522, so passes
    ak_atap_gross_income_eligible: true

#############################################
# Large Family Size with Gross Income Limit
#############################################

- name: Edge 23, large adult-included family size 11 gross income limit.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
      person2:
        age: 17
      person3:
        age: 15
      person4:
        age: 13
      person5:
        age: 11
      person6:
        age: 9
      person7:
        age: 7
      person8:
        age: 5
      person9:
        age: 3
      person10:
        age: 2
      person11:
        age: 1
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11]
        ak_atap_is_child_only_unit: false
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8, person9, person10, person11]
        state_code: AK
  output:
    # Size 11 adult-included 185% limit = $3,217
    # (Size 10: $3,086 + $131 per additional person)
    ak_atap_gross_income_limit: 3_217

#############################################
# Combined Edge Cases - Integration
#############################################

- name: Edge 24, very large family full benefit calculation.
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 40
        employment_income_before_lsr: 0
      person2:
        age: 17
      person3:
        age: 15
      person4:
        age: 13
      person5:
        age: 11
      person6:
        age: 9
      person7:
        age: 7
      person8:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
        state_code: AK
  output:
    # Size 8 adult-included
    # Need: $1,525
    # Payment: $821 + 6*$102 = $821 + $612 = $1,433
    # Benefit: floor($1,525 * $821 / $823) = floor(1521.27) = $1,521
    ak_atap_need_standard: 1_525
    ak_atap_maximum_payment: 1_433
    ak_atap: 1_521

- name: Edge 25, combined earned and unearned with all edge values.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_800  # $150/month = exactly flat deduction
        child_support_received: 600  # $50/month = exactly passthrough
        social_security: 1_200  # $100/month other unearned
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AK
  output:
    # Earned: $150, flat: $150, after_flat: $0, percent: $0
    # Countable earned: max(150 - 150, 0) = 0
    # Child support: $50 - $50 = $0 countable
    # Other unearned (SS): $100
    # Total countable unearned: $0 + $100 = $100
    ak_atap_countable_earned_income: 0
    ak_atap_countable_unearned_income: 100
