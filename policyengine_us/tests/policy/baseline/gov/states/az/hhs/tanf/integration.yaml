# Integration tests for Arizona TANF - full pipeline testing
# Tests realistic family scenarios with complete eligibility and benefit calculations
# Reference: https://des.az.gov/services/child-and-family/cash-assistance/cash-assistance-ca-income-eligibility-guidelines
#
# Key Arizona TANF rules:
# - Earned income disregard: $90 flat + 30% of remainder
# - Payment standard: A1 (36% of 1992 FPG) with shelter, A2 (A1 reduced by 37%) without
# - 1992 FPG (CONTIGUOUS_US): first_person = $6,810, additional = $2,380
# - Resource limit: $2,000
# - Needy family test: FPG rate * current FPG (100% for parents, 130% for non-parent relatives)

- name: Scenario 1, single parent with 2 children, no income - full benefit.
  # Family of 3, no income, receives full A1 payment standard
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 7_200
      person2:
        age: 5
      person3:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        spm_unit_assets: 1_000
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true, true]
    # Income calculation
    az_tanf_earned_income_after_disregard_person: [0, 0, 0]
    az_tanf_countable_earned_income: 0
    az_tanf_countable_income: 0
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 3, 1992 FPG: $11,570 annual
    # Monthly: $11,570 / 12 = $964.17
    # A1 rate (with shelter): 36%
    # Payment standard: $964.17 * 0.36 = $347.10
    az_tanf_payment_standard: 347
    # Benefit: $347 - $0 = $347
    az_tanf: 347

- name: Scenario 2, family of 3 with $500 monthly earnings.
  # Standard earned income calculation with $90 flat + 30% disregard
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 28
        employment_income_before_lsr: 6_000  # $500/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 6_600
      person2:
        age: 4
      person3:
        age: 2
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        spm_unit_assets: 500
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true, true]
    # Income calculation
    # Person1: $500 - $90 flat = $410, * 0.70 = $287
    az_tanf_earned_income_after_disregard_person: [287, 0, 0]
    az_tanf_countable_earned_income: 287
    az_tanf_countable_income: 287
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Payment standard (family of 3, A1): $347
    az_tanf_payment_standard: 347
    # Benefit: $347 - $287 = $60
    az_tanf: 60

- name: Scenario 3, single parent with one child, with childcare.
  # Family of 2, earned income with dependent care deduction
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 6_000  # $500/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 4_800
      person2:
        age: 1
        is_child: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        spm_unit_assets: 800
        childcare_expenses: 3_600  # $300/month annual
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true]
    # Income calculation
    # Person1: $500 - $90 = $410, * 0.70 = $287
    az_tanf_earned_income_after_disregard_person: [287, 0]
    # Dependent care for child under 2: min($300, $200) = $200
    az_tanf_dependent_care_deduction: 200
    # Countable earned: $287 - $200 = $87
    az_tanf_countable_earned_income: 87
    az_tanf_countable_income: 87
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 2, 1992 FPG: $9,190 annual
    # Monthly: $9,190 / 12 = $765.83
    # A1 rate: 36%
    # Payment standard: $765.83 * 0.36 = $275.70 ~ $276
    az_tanf_payment_standard: 276
    # Benefit: $276 - $87 = $189
    az_tanf: 189

- name: Scenario 4, family ineligible due to income exceeding payment standard.
  # Gross income passes needy family test, but countable exceeds payment standard
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 32
        employment_income_before_lsr: 9_600  # $800/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 6_000
      person2:
        age: 7
    spm_units:
      spm_unit:
        members: [person1, person2]
        spm_unit_assets: 1_200
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true]
    # Income calculation
    # Person1: $800 - $90 = $710, * 0.70 = $497
    az_tanf_earned_income_after_disregard_person: [497, 0]
    az_tanf_countable_earned_income: 497
    az_tanf_countable_income: 497
    # Payment standard (A1 for family of 2): ~$276
    az_tanf_payment_standard: 276
    # $497 > $276 - fails payment standard test
    az_tanf_income_eligible: false
    az_tanf_eligible: false
    az_tanf: 0

- name: Scenario 5, ineligible due to excess resources.
  # Income eligible but assets exceed $2,000 limit
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 6_000
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
        spm_unit_assets: 3_000  # Exceeds $2,000 limit
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AZ
  output:
    # Resources exceed limit
    az_tanf_resources_eligible: false
    az_tanf_eligible: false
    az_tanf: 0

- name: Scenario 6, combined earned and unearned income.
  # Tests handling of both income types
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 29
        employment_income_before_lsr: 4_800  # $400/month annual
        child_support_received: 1_200  # $100/month annual unearned
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 5_400
      person2:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
        spm_unit_assets: 1_000
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true]
    # Income calculation
    # Person1 earned: $400 - $90 = $310, * 0.70 = $217
    az_tanf_earned_income_after_disregard_person: [217, 0]
    az_tanf_countable_earned_income: 217
    # Unearned (child support): $100 (no disregard)
    # Total countable: $217 + $100 = $317
    az_tanf_countable_income: 317
    # Eligibility
    az_tanf_resources_eligible: true
    # Payment standard (A1 for family of 2): ~$276
    az_tanf_payment_standard: 276
    # $317 > $276 - fails payment standard test
    az_tanf_income_eligible: false
    az_tanf_eligible: false
    az_tanf: 0

- name: Scenario 7, large family of 5 with partial benefit.
  # Tests larger family size payment standard
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 38
        employment_income_before_lsr: 4_800  # $400/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 9_600
      person2:
        age: 36
        own_children_in_household: 1
      person3:
        age: 14
      person4:
        age: 10
      person5:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5]
        spm_unit_assets: 1_500
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4, person5]
    households:
      household:
        members: [person1, person2, person3, person4, person5]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, false, true, true, true]
    # Income calculation
    # Person1: $400 - $90 = $310, * 0.70 = $217
    az_tanf_earned_income_after_disregard_person: [217, 0, 0, 0, 0]
    az_tanf_countable_earned_income: 217
    az_tanf_countable_income: 217
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 5, 1992 FPG: $16,330 annual
    # Monthly: $16,330 / 12 = $1,360.83
    # A1 rate: 36%
    # Payment standard: $1,360.83 * 0.36 = $489.90 ~ $490
    az_tanf_payment_standard: 490
    # Benefit: $490 - $217 = $273
    az_tanf: 273

- name: Scenario 8, two working adults with childcare.
  # Multi-earner household with dependent care deduction
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 6_000  # $500/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 8_400
      person2:
        age: 28
        employment_income_before_lsr: 4_800  # $400/month annual
        own_children_in_household: 1
      person3:
        age: 1
        is_child: true
      person4:
        age: 4
        is_child: true
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
        spm_unit_assets: 1_200
        childcare_expenses: 6_000  # $500/month annual
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4]
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, false, true, true]
    # Income calculation
    # Person1: $500 - $90 = $410, * 0.70 = $287
    # Person2: $400 - $90 = $310, * 0.70 = $217
    az_tanf_earned_income_after_disregard_person: [287, 217, 0, 0]
    # Total after disregards: $287 + $217 = $504
    # Dependent care: child under 2 ($200) + child 2+ ($175) = $375
    az_tanf_dependent_care_deduction: 375
    # Countable earned: $504 - $375 = $129
    az_tanf_countable_earned_income: 129
    az_tanf_countable_income: 129
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 4, 1992 FPG: $13,950 annual
    # Monthly: $13,950 / 12 = $1,162.50
    # A1 rate: 36%
    # Payment standard: $1,162.50 * 0.36 = $418.50 ~ $419
    az_tanf_payment_standard: 419
    # Benefit: $419 - $129 = $290
    az_tanf: 290

- name: Scenario 9, family without shelter costs (A2 payment standard).
  # Tests lower A2 payment standard without shelter costs
  period: 2024-01
  absolute_error_margin: 1
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_800  # $150/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
      person2:
        age: 5
      person3:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        spm_unit_assets: 500
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true, true]
    # Income calculation
    # Person1: $150 - $90 = $60, * 0.70 = $42
    az_tanf_earned_income_after_disregard_person: [42, 0, 0]
    az_tanf_countable_earned_income: 42
    az_tanf_countable_income: 42
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 3, 1992 FPG: $11,570 annual
    # Monthly: $11,570 / 12 = $964.17
    # A2: A1 (36%) reduced by 37% = 36% ร 63% = 22.68%
    # Payment standard: $964.17 * 0.36 * 0.63 = $218.67 ~ $219
    az_tanf_payment_standard: 219
    # Benefit: $219 - $42 = $177
    az_tanf: 177

- name: Scenario 10, historical period with 20% benefit cut (2023).
  # Tests the reduced benefit rate during 2009-2023 period (0.288 instead of 0.36)
  # Reference: Arizona implemented 20% cut during Great Recession (restored Dec 2023)
  period: 2023-01
  absolute_error_margin: 0.1
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 7_200
      person2:
        age: 5
      person3:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        spm_unit_assets: 1_000
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true, true]
    # Income calculation - no income
    az_tanf_countable_income: 0
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 3, 1992 FPG: $11,570 annual
    # Monthly: $11,570 / 12 = $964.17
    # A1 rate in 2023: 28.8% (20% cut from 36%)
    # Payment standard: $964.17 * 0.288 = $277.68
    az_tanf_payment_standard: 277.68
    # Benefit: $277.68 - $0 = $277.68
    az_tanf: 277.68

- name: Scenario 11, non-parent relative caretaker with income.
  # Tests 130% FPG rate for non-parent relative (grandparent caring for grandchild)
  # Reference: A.R.S. ยง 46-292 - non-parent relative cases have 130% FPG limit
  period: 2024-01
  absolute_error_margin: 0.1
  input:
    people:
      person1:
        age: 55
        employment_income_before_lsr: 3_600  # $300/month annual
        is_tax_unit_head: true
        own_children_in_household: 0  # Not the parent
        pre_subsidy_rent: 6_000
      person2:
        age: 8
        is_child: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        spm_unit_assets: 1_500
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AZ
  output:
    # Demographics
    is_person_demographic_tanf_eligible: [false, true]
    # Non-parent relative case: head has no own children, unit has children
    az_tanf_fpg_rate: 1.3  # 130% FPG rate for non-parent relative
    # Income calculation
    # Person1: $300 - $90 = $210, * 0.70 = $147
    az_tanf_earned_income_after_disregard_person: [147, 0]
    az_tanf_countable_earned_income: 147
    az_tanf_countable_income: 147
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 2, 1992 FPG: $9,190 annual
    # Monthly: $9,190 / 12 = $765.83
    # A1 rate: 36%
    # Payment standard: $765.83 * 0.36 = $275.70
    az_tanf_payment_standard: 275.7
    # Benefit: $275.70 - $147 = $128.70
    az_tanf: 128.7

- name: Scenario 12, large family of 6 members.
  # Tests payment standard extrapolation for family size > 5
  # 1992 FPG formula: $6,810 + (n-1) * $2,380
  period: 2024-01
  absolute_error_margin: 0.1
  input:
    people:
      person1:
        age: 40
        employment_income_before_lsr: 3_600  # $300/month annual
        is_tax_unit_head: true
        own_children_in_household: 1
        pre_subsidy_rent: 10_800
      person2:
        age: 38
        own_children_in_household: 1
      person3:
        age: 16
      person4:
        age: 12
      person5:
        age: 8
      person6:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6]
        spm_unit_assets: 1_800
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4, person5, person6]
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6]
        state_code: AZ
  output:
    # Demographics - only children under 18 are demographically eligible
    is_person_demographic_tanf_eligible: [false, false, true, true, true, true]
    # Income calculation
    # Person1: $300 - $90 = $210, * 0.70 = $147
    az_tanf_earned_income_after_disregard_person: [147, 0, 0, 0, 0, 0]
    az_tanf_countable_earned_income: 147
    az_tanf_countable_income: 147
    # Eligibility
    az_tanf_resources_eligible: true
    az_tanf_income_eligible: true
    az_tanf_eligible: true
    # Family of 6, 1992 FPG: $6,810 + 5*$2,380 = $18,710 annual
    # Monthly: $18,710 / 12 = $1,559.17
    # A1 rate: 36%
    # Payment standard: $1,559.17 * 0.36 = $561.30
    az_tanf_payment_standard: 561.3
    # Benefit: $561.30 - $147 = $414.30
    az_tanf: 414.3
