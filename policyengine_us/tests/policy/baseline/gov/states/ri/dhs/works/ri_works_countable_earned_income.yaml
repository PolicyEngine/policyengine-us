# Unit tests for Rhode Island TANF countable earned income
# 218-RICR-20-00-2.15: Earned income disregards
# Formula per earner: Countable Earned = max((Gross Earned - $525), 0) * 0.5
# "This disregard is allowed for each individual who has otherwise been
# found eligible to receive cash assistance."
# https://www.law.cornell.edu/regulations/rhode-island/218-RICR-20-00-2.15

- name: Case 1, no earned income.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Gross earned: $0
    # After $525 disregard: max($0 - $525, 0) = $0
    # 50% disregard: $0 * 0.5 = $0
    # Countable earned: $0
    ri_works_countable_earned_income: 0

- name: Case 2, earned income below $525 flat disregard.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 4_800  # $400/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $400
    # After $525 disregard: max($400 - $525, 0) = $0
    # 50% disregard: $0 * 0.5 = $0
    # Countable earned: $0
    ri_works_countable_earned_income: 0

- name: Case 3, earned income exactly at $525 flat disregard.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 6_300  # $525/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $525
    # After $525 disregard: max($525 - $525, 0) = $0
    # 50% disregard: $0 * 0.5 = $0
    # Countable earned: $0
    ri_works_countable_earned_income: 0

- name: Case 4, earned income above flat disregard.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12_000  # $1,000/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $1,000
    # After $525 disregard: max($1,000 - $525, 0) = $475
    # 50% disregard: $475 * 0.5 = $237.50
    # Countable earned: $237.50
    ri_works_countable_earned_income: 237.5

- name: Case 5, higher earned income.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 24_000  # $2,000/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $2,000
    # After $525 disregard: max($2,000 - $525, 0) = $1,475
    # 50% disregard: $1,475 * 0.5 = $737.50
    # Countable earned: $737.50
    ri_works_countable_earned_income: 737.5

- name: Case 6, two earners in household.
  period: 2025-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 12_000  # $1,000/month
      person2:
        age: 32
        employment_income_before_lsr: 6_000  # $500/month
      person3:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: RI
  output:
    # Per 218-RICR-20-00-2.15: $525 disregard applies PER EARNER
    # Person 1: max($1,000 - $525, 0) * 0.5 = $475 * 0.5 = $237.50
    # Person 2: max($500 - $525, 0) * 0.5 = $0 * 0.5 = $0
    # Total countable earned: $237.50
    ri_works_countable_earned_income: 237.5

# Edge cases for $525 disregard boundary

- name: Case 7, earned income one dollar below $525 threshold.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 6_288  # $524/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $524
    # After $525 disregard: max($524 - $525, 0) = $0
    # 50% disregard: $0 * 0.5 = $0
    # Countable earned: $0
    ri_works_countable_earned_income: 0

- name: Case 8, earned income one dollar above $525 threshold.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 6_312  # $526/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $526
    # After $525 disregard: max($526 - $525, 0) = $1
    # 50% disregard: $1 * 0.5 = $0.50
    # Countable earned: $0.50
    ri_works_countable_earned_income: 0.5

- name: Case 9, very high earned income to test no negative values.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 60_000  # $5,000/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $5,000
    # After $525 disregard: max($5,000 - $525, 0) = $4,475
    # 50% disregard: $4,475 * 0.5 = $2,237.50
    # Countable earned: $2,237.50
    ri_works_countable_earned_income: 2_237.5

- name: Case 10, earned income at $1 tests very low values.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12  # $1/month
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Monthly gross earned: $1
    # After $525 disregard: max($1 - $525, 0) = $0
    # 50% disregard: $0 * 0.5 = $0
    # Countable earned: $0 (all disregarded)
    ri_works_countable_earned_income: 0

# Edge cases: Dependent care interaction with earned income

- name: Case 11, earned income with dependent care deduction.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 18_000  # $1,500/month
      person2:
        age: 3
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        childcare_expenses: 4_800  # $400/month * 12
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Per-earner disregard: max($1,500 - $525, 0) * 0.5 = $487.50
    # Max dependent care (age 3): $175
    # Expenses ($400) > max ($175), so deduction = $175
    # Countable earned: max($487.50 - $175, 0) = $312.50
    ri_works_countable_earned_income: 312.5

- name: Case 12, dependent care exceeds earned income after disregard.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 7_200  # $600/month
      person2:
        age: 1
        is_tax_unit_dependent: true
      person3:
        age: 3
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        childcare_expenses: 6_000  # $500/month * 12
    households:
      household:
        members: [person1, person2, person3]
        state_code: RI
  output:
    # Per-earner disregard: max($600 - $525, 0) * 0.5 = $37.50
    # Max dependent care: $200 (age 1) + $175 (age 3) = $375
    # Deduction = min($500, $375) = $375
    # Countable earned: max($37.50 - $375, 0) = $0 (floors at 0)
    ri_works_countable_earned_income: 0

- name: Case 13, no earned income with childcare expenses.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
      person2:
        age: 3
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        childcare_expenses: 3_600  # $300/month * 12
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # No earned income, dependent care has no effect
    # Countable earned: $0
    ri_works_countable_earned_income: 0

# Edge cases: Three or more earners

- name: Case 14, three earners in household.
  period: 2025-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 12_000  # $1,000/month
      person2:
        age: 32
        employment_income_before_lsr: 4_800  # $400/month (below $525)
      person3:
        age: 18
        employment_income_before_lsr: 9_600  # $800/month
      person4:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: RI
  output:
    # Person 1: max($1,000 - $525, 0) * 0.5 = $237.50
    # Person 2: max($400 - $525, 0) * 0.5 = $0
    # Person 3: max($800 - $525, 0) * 0.5 = $137.50
    # Total countable earned: $237.50 + $0 + $137.50 = $375
    ri_works_countable_earned_income: 375

- name: Case 15, two earners both below $525 threshold.
  period: 2025-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 4_800  # $400/month
      person2:
        age: 32
        employment_income_before_lsr: 3_600  # $300/month
      person3:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: RI
  output:
    # Per-earner disregard applies separately
    # Person 1: max($400 - $525, 0) * 0.5 = $0
    # Person 2: max($300 - $525, 0) * 0.5 = $0
    # Total: $0 (NOT $175 if incorrectly combined)
    ri_works_countable_earned_income: 0

# Edge case: Negative income from self-employment

- name: Case 16, self-employment loss.
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        self_employment_income_before_lsr: -6_000  # -$500/month loss
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: RI
  output:
    # Self-employment loss: -$500/month
    # tanf_gross_earned_income floors at 0 for negative SE income
    # After $525 disregard: max($0 - $525, 0) = $0
    # Countable earned: $0
    ri_works_countable_earned_income: 0
