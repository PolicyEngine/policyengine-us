# North Dakota TANF Integration Tests
# Tests the complete benefit calculation pipeline
#
# Key Parameters (2024-01):
# - Standard Employment Expense: max(27% of gross earned, $180)
# - Time Limited Percentage (TLP) disregard: 50% of remaining earned income
# - Standard of Need: 50% of Federal Poverty Level
# - Income Eligibility: Countable income < Standard of Need (strict less than)
# - Minimum benefit: $10
# - Housing supplement: $50 (when applicable)
#
# IMPORTANT: For period 2024-01, tanf_fpg uses the prior October's FPL values
# (2023-10-01), which are the 2023 FPL values.
#
# 2023 FPG (Contiguous US) - used for 2024-01:
# - 1 person: $14,580/year
# - Additional person: $5,140/year
# - Family of 3: $14,580 + 2*$5,140 = $24,860/year
#
# Standard of Need (50% FPL) for family of 3:
# - Annual: $24,860 * 0.50 = $12,430
# - Monthly: $12,430 / 12 = $1,035.83
#
# NOTE: Uses employment_income_before_lsr as input since that is what
# tanf_gross_earned_income expects.

- name: Case 1, family of 3 with no income receives full benefit.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 8
      person3:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # FPL for family of 3 (2023): $14,580 + 2*$5,140 = $24,860/year
    # Standard of Need (50% FPL): $24,860 * 0.50 / 12 = $1,035.83/month
    nd_tanf_standard_of_need: 1_035.83
    nd_tanf_countable_earned_income: 0
    nd_tanf_countable_unearned_income: 0
    nd_tanf_countable_income: 0
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = Standard of Need - Countable Income = $1,035.83 - $0 = $1,035.83
    nd_tanf: 1_035.83

- name: Case 2, family of 3 with moderate earned income.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        # Monthly: $1,500; Annual: $18,000
        employment_income_before_lsr: 18_000
      person2:
        age: 10
      person3:
        age: 7
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # Gross monthly earned income: $18,000 / 12 = $1,500
    # Standard Employment Expense: max($1,500 * 0.27, $180) = max($405, $180) = $405
    # After SEE: $1,500 - $405 = $1,095
    # TLP disregard (50%): $1,095 * 0.50 = $547.50
    # Countable earned: $1,095 - $547.50 = $547.50
    nd_tanf_countable_earned_income: 547.50
    nd_tanf_countable_unearned_income: 0
    nd_tanf_countable_income: 547.50
    # Standard of Need (family of 3, 2023 FPL): $1,035.83
    nd_tanf_standard_of_need: 1_035.83
    # Income eligible: $547.50 < $1,035.83 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $1,035.83 - $547.50 = $488.33
    nd_tanf: 488.33

- name: Case 3, family of 3 with earned and unearned income.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 28
        # Monthly earned: $1,000; Annual: $12,000
        employment_income_before_lsr: 12_000
        # Monthly unearned: $200; Annual: $2,400
        social_security_dependents: 2_400
      person2:
        age: 6
      person3:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # Gross monthly earned income: $12,000 / 12 = $1,000
    # Standard Employment Expense: max($1,000 * 0.27, $180) = max($270, $180) = $270
    # After SEE: $1,000 - $270 = $730
    # TLP disregard (50%): $730 * 0.50 = $365
    # Countable earned: $730 - $365 = $365
    nd_tanf_countable_earned_income: 365
    # Countable unearned: $2,400 / 12 = $200
    nd_tanf_countable_unearned_income: 200
    # Total countable: $365 + $200 = $565
    nd_tanf_countable_income: 565
    nd_tanf_standard_of_need: 1_035.83
    # Income eligible: $565 < $1,035.83 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $1,035.83 - $565 = $470.83
    nd_tanf: 470.83

- name: Case 4, low earned income applies minimum $180 deduction.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 25
        # Monthly: $500; Annual: $6,000
        employment_income_before_lsr: 6_000
      person2:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Gross monthly earned income: $6,000 / 12 = $500
    # Standard Employment Expense: max($500 * 0.27, $180) = max($135, $180) = $180
    # After SEE: $500 - $180 = $320
    # TLP disregard (50%): $320 * 0.50 = $160
    # Countable earned: $320 - $160 = $160
    nd_tanf_countable_earned_income: 160
    nd_tanf_countable_unearned_income: 0
    nd_tanf_countable_income: 160
    # FPL for family of 2 (2023): $14,580 + $5,140 = $19,720/year
    # Standard of Need (50% FPL): $19,720 * 0.50 / 12 = $821.67/month
    nd_tanf_standard_of_need: 821.67
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $821.67 - $160 = $661.67
    nd_tanf: 661.67

- name: Case 5, income resulting in low benefit but above minimum.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 32
        # Monthly: $2,000; Annual: $24,000
        employment_income_before_lsr: 24_000
      person2:
        age: 2
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly earned: $24,000 / 12 = $2,000
    # SEE: max($2,000 * 0.27, $180) = $540
    # After SEE: $2,000 - $540 = $1,460
    # TLP: $1,460 * 0.50 = $730
    # Countable earned: $730
    nd_tanf_countable_earned_income: 730
    nd_tanf_countable_income: 730
    nd_tanf_standard_of_need: 821.67
    # Income eligible: $730 < $821.67 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $821.67 - $730 = $91.67
    nd_tanf: 91.67

- name: Case 6, income over eligibility limit results in zero benefit.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 40
        # Monthly: $3,000; Annual: $36,000
        employment_income_before_lsr: 36_000
      person2:
        age: 12
      person3:
        age: 9
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # Monthly earned: $36,000 / 12 = $3,000
    # SEE: max($3,000 * 0.27, $180) = max($810, $180) = $810
    # After SEE: $3,000 - $810 = $2,190
    # TLP: $2,190 * 0.50 = $1,095
    # Countable earned: $1,095
    nd_tanf_countable_earned_income: 1_095
    nd_tanf_countable_income: 1_095
    nd_tanf_standard_of_need: 1_035.83
    # Income eligible: $1,095 < $1,035.83 = false
    nd_tanf_income_eligible: false
    nd_tanf_eligible: false
    nd_tanf: 0

- name: Case 7, single person household with unearned income only.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 22
        is_pregnant: true
        # Monthly unearned: $400; Annual: $4,800
        social_security_dependents: 4_800
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: ND
  output:
    # No earned income, so no deductions
    nd_tanf_countable_earned_income: 0
    # Countable unearned: $4,800 / 12 = $400
    nd_tanf_countable_unearned_income: 400
    nd_tanf_countable_income: 400
    # FPL for 1 person (2023): $14,580/year
    # Standard of Need (50% FPL): $14,580 * 0.50 / 12 = $607.50/month
    nd_tanf_standard_of_need: 607.50
    # Income eligible: $400 < $607.50 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $607.50 - $400 = $207.50
    nd_tanf: 207.50

# Edge Case Integration Tests

- name: Case 8, large household (8 persons) with moderate income.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 45
        # Monthly: $2,000; Annual: $24,000
        employment_income_before_lsr: 24_000
      person2:
        age: 43
      person3:
        age: 17
      person4:
        age: 15
      person5:
        age: 12
      person6:
        age: 9
      person7:
        age: 6
      person8:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
        state_code: ND
  output:
    # FPL for 8 persons (2023): $14,580 + 7*$5,140 = $50,560/year
    # Standard of Need (50% FPL): $50,560 * 0.50 / 12 = $2,106.67/month
    nd_tanf_standard_of_need: 2_106.67
    # Monthly earned: $24,000 / 12 = $2,000
    # SEE: max($2,000 * 0.27, $180) = max($540, $180) = $540
    # After SEE: $2,000 - $540 = $1,460
    # TLP: $1,460 * 0.50 = $730
    # Countable earned: $730
    nd_tanf_countable_earned_income: 730
    nd_tanf_countable_unearned_income: 0
    nd_tanf_countable_income: 730
    # Income eligible: $730 < $2,106.67 = true
    nd_tanf_income_eligible: true
    # Resource limit for 8 persons: $6,000 + $25 * 6 = $6,150
    nd_tanf_resource_eligible: true
    nd_tanf_eligible: true
    # Benefit = $2,106.67 - $730 = $1,376.67
    nd_tanf: 1_376.67

- name: Case 9, ineligible due to resources exceeding limit.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 8
    spm_units:
      spm_unit:
        members: [person1, person2]
        # Resources over limit ($6,000 for 2 persons)
        spm_unit_assets: 6_500
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Standard of Need for 2 persons (2023 FPL): $821.67
    nd_tanf_standard_of_need: 821.67
    nd_tanf_countable_income: 0
    nd_tanf_income_eligible: true
    # Resource limit for 2 persons: $6,000
    # $6,500 > $6,000 = false
    nd_tanf_resource_eligible: false
    nd_tanf_eligible: false
    nd_tanf: 0

- name: Case 10, very low income where deductions exceed gross.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 26
        # Monthly: $100; Annual: $1,200
        employment_income_before_lsr: 1_200
      person2:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Standard of Need for 2 persons (2023 FPL): $821.67
    nd_tanf_standard_of_need: 821.67
    # Monthly gross: $1,200 / 12 = $100
    # SEE: max($100 * 0.27, $180) = max($27, $180) = $180
    # After SEE: max($100 - $180, 0) = $0 (clipped)
    # TLP: $0 * 0.50 = $0
    # Countable earned: max($100 - $180 - $0, 0) = $0
    nd_tanf_countable_earned_income: 0
    nd_tanf_countable_unearned_income: 0
    nd_tanf_countable_income: 0
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $821.67 - $0 = $821.67
    nd_tanf: 821.67

- name: Case 11, benefit just below minimum threshold receives zero.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
        # Target: benefit < $10
        # For 2 person (2023 FPL): Standard = $821.67
        # If countable = $815, benefit = $6.67 < $10
        # Using unearned income: $815 * 12 = $9,780
        social_security_dependents: 9_780
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    nd_tanf_standard_of_need: 821.67
    nd_tanf_countable_earned_income: 0
    # Countable unearned: $9,780 / 12 = $815
    nd_tanf_countable_unearned_income: 815
    nd_tanf_countable_income: 815
    # Income eligible: $815 < $821.67 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $821.67 - $815 = $6.67
    # $6.67 < $10 minimum, so no benefit issued
    nd_tanf: 0

- name: Case 12, benefit exactly at minimum threshold is issued.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 28
        # Target countable: $821.67 - $10 = $811.67
        # Unearned: $811.67 * 12 = $9,740.04 (round to $9,740)
        social_security_dependents: 9_740
      person2:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    nd_tanf_standard_of_need: 821.67
    nd_tanf_countable_earned_income: 0
    # Countable unearned: $9,740 / 12 = $811.67
    nd_tanf_countable_unearned_income: 811.67
    nd_tanf_countable_income: 811.67
    # Income eligible: $811.67 < $821.67 = true
    nd_tanf_income_eligible: true
    nd_tanf_eligible: true
    # Benefit = $821.67 - $811.67 = $10.00
    # $10.00 >= $10 minimum, so benefit is issued
    nd_tanf: 10
