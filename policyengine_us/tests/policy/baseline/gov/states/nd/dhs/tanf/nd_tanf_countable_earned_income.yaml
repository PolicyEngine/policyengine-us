# North Dakota TANF Countable Earned Income Unit Tests
#
# Calculation:
# 1. Start with gross earned income
# 2. Apply Standard Employment Expense Allowance: max(27% of gross, $180)
# 3. Apply Time Limited Percentage (TLP) disregard: 50% of remaining
# 4. Result is countable earned income (clipped to 0 if negative)
#
# Formula: countable = max(gross - SEE - TLP, 0)
# where TLP = max(gross - SEE, 0) * 0.50
#
# NOTE: Uses employment_income_before_lsr as input since that is what
# tanf_gross_earned_income expects.

- name: Case 1, zero earned income.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
      person2:
        age: 8
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # No income, no deductions
    nd_tanf_countable_earned_income: 0

- name: Case 2, low income uses $180 minimum deduction.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 25
        # Monthly: $500; Annual: $6,000
        employment_income_before_lsr: 6_000
      person2:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $6,000 / 12 = $500
    # SEE: max($500 * 0.27, $180) = max($135, $180) = $180 (minimum applies)
    # After SEE: $500 - $180 = $320
    # TLP (50%): $320 * 0.50 = $160
    # Countable earned: $160
    nd_tanf_countable_earned_income: 160

- name: Case 3, moderate income uses percentage deduction.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        # Monthly: $1,500; Annual: $18,000
        employment_income_before_lsr: 18_000
      person2:
        age: 10
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $18,000 / 12 = $1,500
    # SEE: max($1,500 * 0.27, $180) = max($405, $180) = $405 (percentage applies)
    # After SEE: $1,500 - $405 = $1,095
    # TLP (50%): $1,095 * 0.50 = $547.50
    # Countable earned: $547.50
    nd_tanf_countable_earned_income: 547.50

- name: Case 4, income at threshold where percentage equals minimum.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 28
        # At $666.67/month, 27% = $180
        # Monthly: $666.67; Annual: $8,000 (approx)
        # Using $8,000 -> $666.67/month
        employment_income_before_lsr: 8_000
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $8,000 / 12 = $666.67
    # SEE: max($666.67 * 0.27, $180) = max($180, $180) = $180
    # After SEE: $666.67 - $180 = $486.67
    # TLP (50%): $486.67 * 0.50 = $243.33
    # Countable earned: $243.33
    nd_tanf_countable_earned_income: 243.33

- name: Case 5, higher income with percentage deduction.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 40
        # Monthly: $2,500; Annual: $30,000
        employment_income_before_lsr: 30_000
      person2:
        age: 12
      person3:
        age: 9
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # Monthly gross: $30,000 / 12 = $2,500
    # SEE: max($2,500 * 0.27, $180) = max($675, $180) = $675
    # After SEE: $2,500 - $675 = $1,825
    # TLP (50%): $1,825 * 0.50 = $912.50
    # Countable earned: $912.50
    nd_tanf_countable_earned_income: 912.50

- name: Case 6, multiple earners in household.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        # Monthly: $1,000; Annual: $12,000
        employment_income_before_lsr: 12_000
      person2:
        age: 33
        # Monthly: $800; Annual: $9,600
        employment_income_before_lsr: 9_600
      person3:
        age: 7
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: ND
  output:
    # Person1 monthly gross: $12,000 / 12 = $1,000
    # Person1 SEE: max($1,000 * 0.27, $180) = max($270, $180) = $270
    # Person1 after SEE: $1,000 - $270 = $730
    # Person1 TLP (50%): $730 * 0.50 = $365
    #
    # Person2 monthly gross: $9,600 / 12 = $800
    # Person2 SEE: max($800 * 0.27, $180) = max($216, $180) = $216
    # Person2 after SEE: $800 - $216 = $584
    # Person2 TLP (50%): $584 * 0.50 = $292
    #
    # Total countable earned: $365 + $292 = $657
    nd_tanf_countable_earned_income: 657

# Edge Case Tests

- name: Case 7, very low income where deductions exceed gross (clips to 0).
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 26
        # Monthly: $100; Annual: $1,200
        employment_income_before_lsr: 1_200
      person2:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $1,200 / 12 = $100
    # SEE: max($100 * 0.27, $180) = max($27, $180) = $180 (minimum applies)
    # After SEE: max($100 - $180, 0) = max(-$80, 0) = $0 (clipped to 0)
    # TLP (50%): $0 * 0.50 = $0
    # Countable earned: max($100 - $180 - $0, 0) = max(-$80, 0) = $0
    nd_tanf_countable_earned_income: 0

- name: Case 8, income exactly at $180 (SEE equals gross).
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 24
        # Monthly: $180; Annual: $2,160
        employment_income_before_lsr: 2_160
      person2:
        age: 2
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $2,160 / 12 = $180
    # SEE: max($180 * 0.27, $180) = max($48.60, $180) = $180 (minimum applies)
    # After SEE: max($180 - $180, 0) = $0
    # TLP (50%): $0 * 0.50 = $0
    # Countable earned: max($180 - $180 - $0, 0) = $0
    nd_tanf_countable_earned_income: 0

- name: Case 9, income just above $180 (small countable amount).
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 27
        # Monthly: $200; Annual: $2,400
        employment_income_before_lsr: 2_400
      person2:
        age: 6
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $2,400 / 12 = $200
    # SEE: max($200 * 0.27, $180) = max($54, $180) = $180 (minimum applies)
    # After SEE: $200 - $180 = $20
    # TLP (50%): $20 * 0.50 = $10
    # Countable earned: $200 - $180 - $10 = $10
    nd_tanf_countable_earned_income: 10

- name: Case 10, income just below crossover uses minimum.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 29
        # Monthly: $650; Annual: $7,800
        # 27% of $650 = $175.50 < $180
        employment_income_before_lsr: 7_800
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $7,800 / 12 = $650
    # SEE: max($650 * 0.27, $180) = max($175.50, $180) = $180 (minimum applies)
    # After SEE: $650 - $180 = $470
    # TLP (50%): $470 * 0.50 = $235
    # Countable earned: $650 - $180 - $235 = $235
    nd_tanf_countable_earned_income: 235

- name: Case 11, income just above crossover uses percentage.
  period: 2024-01
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 31
        # Monthly: $700; Annual: $8,400
        # 27% of $700 = $189 > $180
        employment_income_before_lsr: 8_400
      person2:
        age: 8
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: ND
  output:
    # Monthly gross: $8,400 / 12 = $700
    # SEE: max($700 * 0.27, $180) = max($189, $180) = $189 (percentage applies)
    # After SEE: $700 - $189 = $511
    # TLP (50%): $511 * 0.50 = $255.50
    # Countable earned: $700 - $189 - $255.50 = $255.50
    nd_tanf_countable_earned_income: 255.50
