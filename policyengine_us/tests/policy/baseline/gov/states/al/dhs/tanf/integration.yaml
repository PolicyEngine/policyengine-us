# Integration tests for Alabama TANF - full pipeline testing
# Tests realistic family scenarios with complete eligibility and benefit calculations
# Reference: https://dhr.alabama.gov/wp-content/uploads/2022/04/Appendix-N-Sec-2-Public-Assistance-Payment-Manual.pdf#page=37
# Key rules:
# - Work expense deduction: 20% of earned income
# - Childcare is deducted directly from earned income
# - No asset limit in Alabama

- name: Scenario 1 - Single parent with 2 children, no income - full benefit.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
      person2:
        age: 5
      person3:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AL
  output:
    # Family size: 3
    # Countable earned income: $0
    # Countable income: $0
    # Payment standard (family of 3): $344
    # Benefit: $344 - $0 = $344
    is_person_demographic_tanf_eligible: [false, true, true]
    al_tanf_countable_earned_income: 0
    al_tanf_countable_income: 0
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 344

- name: Scenario 2 - Family of 2 with $600 monthly employment earnings.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 28
        employment_income_before_lsr: 7_200  # $600/month
      person2:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AL
  output:
    # Family size: 2
    # Monthly gross earned income: $600
    # Work expense deduction: $600 * 0.20 = $120
    # Countable earned income: $600 - $120 = $480
    # Countable income: $480
    # Payment standard (family of 2): $304
    # Ineligible: $480 > $304
    # Benefit: $0
    is_person_demographic_tanf_eligible: [false, true]
    al_tanf_countable_earned_income: 480
    al_tanf_countable_income: 480
    al_tanf_income_eligible: false
    al_tanf_eligible: false
    al_tanf: 0

- name: Scenario 3 - Family of 3 with $400 monthly earnings - partial benefit.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 32
        employment_income_before_lsr: 4_800  # $400/month
      person2:
        age: 7
      person3:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: AL
  output:
    # Family size: 3
    # Monthly gross earned income: $400
    # Work expense deduction: $400 * 0.20 = $80
    # Countable earned income: $400 - $80 = $320
    # Countable income: $320
    # Payment standard (family of 3): $344
    # $320 <= $344, eligible
    # Benefit: $344 - $320 = $24
    is_person_demographic_tanf_eligible: [false, true, true]
    al_tanf_countable_earned_income: 320
    al_tanf_countable_income: 320
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 24

- name: Scenario 4 - Family of 4 with self-employment income.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 38
        self_employment_income_before_lsr: 4_800  # $400/month self-employment
      person2:
        age: 35
      person3:
        age: 12
      person4:
        age: 8
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4]
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4]
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: AL
  output:
    # Family size: 4
    # Monthly self-employment: $400
    # Work expense deduction: $400 * 0.20 = $80
    # Countable earned income: $400 - $80 = $320
    # Countable income: $320
    # Payment standard (family of 4): $392
    # $320 <= $392, eligible
    # Benefit: $392 - $320 = $72
    is_person_demographic_tanf_eligible: [false, false, true, true]
    al_tanf_countable_earned_income: 320
    al_tanf_countable_income: 320
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 72

- name: Scenario 5 - Family with combined earned and unearned income.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 29
        employment_income_before_lsr: 3_600  # $300/month earned
        child_support_received: 600  # $50/month unearned
      person2:
        age: 4
    spm_units:
      spm_unit:
        members: [person1, person2]
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AL
  output:
    # Family size: 2
    # Monthly gross earned income: $300
    # Work expense deduction: $300 * 0.20 = $60
    # Countable earned: $300 - $60 = $240
    # Monthly unearned: $50
    # Countable income: $240 + $50 = $290
    # Payment standard (family of 2): $304
    # $290 <= $304, eligible
    # Benefit: $304 - $290 = $14
    is_person_demographic_tanf_eligible: [false, true]
    al_tanf_countable_earned_income: 240
    al_tanf_countable_income: 290
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 14

- name: Scenario 6 - Family of 5 with childcare expenses.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 36
        employment_income_before_lsr: 7_200  # $600/month
      person2:
        age: 34
      person3:
        age: 10
      person4:
        age: 6
      person5:
        age: 2
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5]
        childcare_expenses: 2_400  # $200/month childcare
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4, person5]
    households:
      household:
        members: [person1, person2, person3, person4, person5]
        state_code: AL
  output:
    # Family size: 5
    # Monthly gross earned income: $600
    # Work expense deduction: $600 * 0.20 = $120
    # After work expense: $600 - $120 = $480
    # Childcare: $200
    # Countable earned: max($480 - $200, 0) = $280
    # Countable income: $280
    # Payment standard (family of 5): $440
    # $280 <= $440, eligible
    # Benefit: $440 - $280 = $160
    is_person_demographic_tanf_eligible: [false, false, true, true, true]
    al_tanf_countable_earned_income: 280
    al_tanf_countable_income: 280
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 160

- name: Scenario 7 - Refugee family eligible.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 28
        employment_income_before_lsr: 2_400  # $200/month
        immigration_status: REFUGEE
      person2:
        age: 6
        immigration_status: REFUGEE
    spm_units:
      spm_unit:
        members: [person1, person2]
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AL
  output:
    # Family size: 2
    # Monthly gross earned income: $200
    # Work expense deduction: $200 * 0.20 = $40
    # Countable earned: $200 - $40 = $160
    # Countable income: $160
    # Payment standard (family of 2): $304
    # $160 <= $304, eligible
    # Benefit: $304 - $160 = $144
    is_person_demographic_tanf_eligible: [false, true]
    al_tanf_countable_earned_income: 160
    al_tanf_countable_income: 160
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 144

# ============================================================================
# Edge Case Tests
# ============================================================================

- name: Edge Case 1 - Family of 8 with partial benefit.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 42
        employment_income_before_lsr: 4_800  # $400/month
      person2:
        age: 40
      person3:
        age: 16
      person4:
        age: 14
      person5:
        age: 12
      person6:
        age: 10
      person7:
        age: 8
      person8:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
    households:
      household:
        members: [person1, person2, person3, person4, person5, person6, person7, person8]
        state_code: AL
  output:
    # Family size: 8
    # Monthly gross earned income: $400
    # Work expense deduction: $400 * 0.20 = $80
    # Countable earned income: $400 - $80 = $320
    # Countable income: $320
    # Payment standard (family of 8): $584
    # $320 <= $584, eligible
    # Benefit: $584 - $320 = $264
    is_person_demographic_tanf_eligible: [false, false, true, true, true, true, true, true]
    al_tanf_countable_earned_income: 320
    al_tanf_countable_income: 320
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 264

- name: Edge Case 2 - Childcare exceeds after-work-expense income.
  period: 2024-01
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 3_600  # $300/month
      person2:
        age: 3
    spm_units:
      spm_unit:
        members: [person1, person2]
        childcare_expenses: 3_600  # $300/month
    tax_units:
      tax_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: AL
  output:
    # Monthly employment: $300
    # Work expense deduction: $300 * 0.20 = $60
    # After work expense: $240
    # Childcare: $300
    # Countable earned: max($240 - $300, 0) = max(-$60, 0) = $0
    # Payment standard (2 persons): $304
    # Benefit: $304 - $0 = $304
    is_person_demographic_tanf_eligible: [false, true]
    al_tanf_countable_earned_income: 0
    al_tanf_countable_income: 0
    al_tanf_income_eligible: true
    al_tanf_eligible: true
    al_tanf: 304
