# NY 2025 Income Tax Integration Tests
# Tests verify 2025 tax calculations work correctly with updated parameters
# Reference: https://www.tax.ny.gov/forms/html-instructions/2025/it/it201i-2025.htm

- name: Case 1, single filer standard case.
  # Single filer with $50,000 wages
  # Verify standard deduction, taxable income, and main tax calculation
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 40
        employment_income: 50_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
        state_code: NY
  output:
    # NY AGI equals federal AGI for simple wage income
    ny_agi: 50_000

    # Standard deduction for single filer = $8,000
    ny_standard_deduction: 8_000

    # No dependents = $0 exemptions
    ny_exemptions: 0

    # Taxable income = AGI - deductions - exemptions
    # $50,000 - $8,000 - $0 = $42,000
    ny_taxable_income: 42_000

    # Main tax calculation (2025 single brackets):
    # $0-$8,500: $8,500 * 4% = $340
    # $8,500-$11,700: $3,200 * 4.5% = $144
    # $11,700-$13,900: $2,200 * 5.25% = $115.50
    # $13,900-$42,000: $28,100 * 5.5% = $1,545.50
    # Total = $340 + $144 + $115.50 + $1,545.50 = $2,145
    ny_main_income_tax: 2_145

    # AGI ($50,000) < $107,650, no supplemental tax applies
    ny_supplemental_tax: 0

    # Tax before credits = main tax + supplemental tax
    ny_income_tax_before_credits: 2_145

- name: Case 2, joint filer with two dependents.
  # Joint filer with $80,000 wages and 2 child dependents
  # Verify joint standard deduction and dependent exemptions
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        employment_income: 80_000
        is_tax_unit_head: true
      person2:
        age: 33
        is_tax_unit_spouse: true
      person3:
        age: 10
        is_tax_unit_dependent: true
      person4:
        age: 7
        is_tax_unit_dependent: true
    tax_units:
      tax_unit:
        members: [person1, person2, person3, person4]
        filing_status: JOINT
    households:
      household:
        members: [person1, person2, person3, person4]
        state_code: NY
  output:
    # NY AGI equals federal AGI
    ny_agi: 80_000

    # Joint standard deduction = $16,050
    ny_standard_deduction: 16_050

    # 2 child dependents * $1,000 = $2,000 exemptions
    ny_exemptions: 2_000

    # Taxable income = $80,000 - $16,050 - $2,000 = $61,950
    ny_taxable_income: 61_950

    # Main tax calculation (2025 joint brackets):
    # $0-$17,150: $17,150 * 4% = $686
    # $17,150-$23,600: $6,450 * 4.5% = $290.25
    # $23,600-$27,900: $4,300 * 5.25% = $225.75
    # $27,900-$61,950: $34,050 * 5.5% = $1,872.75
    # Total = $686 + $290.25 + $225.75 + $1,872.75 = $3,074.75
    ny_main_income_tax: 3_074.75

    # AGI ($80,000) < $107,650, no supplemental tax
    ny_supplemental_tax: 0

    ny_income_tax_before_credits: 3_074.75

- name: Case 3, high income triggers supplemental tax.
  # Single filer with $200,000 wages
  # Income above $107,650 threshold triggers supplemental tax calculation
  period: 2025
  absolute_error_margin: 0.5
  input:
    people:
      person1:
        age: 45
        employment_income: 200_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
        state_code: NY
  output:
    ny_agi: 200_000

    # Single standard deduction = $8,000
    ny_standard_deduction: 8_000

    # Taxable income = $200,000 - $8,000 = $192,000
    ny_taxable_income: 192_000

    # Main tax calculation (2025 single brackets):
    # $0-$8,500: $8,500 * 4% = $340
    # $8,500-$11,700: $3,200 * 4.5% = $144
    # $11,700-$13,900: $2,200 * 5.25% = $115.50
    # $13,900-$80,650: $66,750 * 5.5% = $3,671.25
    # $80,650-$192,000: $111,350 * 6% = $6,681
    # Total = $340 + $144 + $115.50 + $3,671.25 + $6,681 = $10,951.75
    ny_main_income_tax: 10_951.75

    # AGI ($200,000) > $107,650, supplemental tax applies
    # Supplemental tax uses phase-in fraction based on income above threshold
    # Phase-in calculation: (AGI - $107,650) / $50,000 = 0.9247
    # Applied to recapture base and incremental benefit
    ny_supplemental_tax: 568

    # Total before credits = $10,951.75 + $568 = $11,519.75
    ny_income_tax_before_credits: 11_519.75

- name: Case 4, head of household with dependent.
  # Head of household with one child
  # Verify HOH standard deduction
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 38
        employment_income: 60_000
        is_tax_unit_head: true
      person2:
        age: 12
        is_tax_unit_dependent: true
    tax_units:
      tax_unit:
        members: [person1, person2]
        filing_status: HEAD_OF_HOUSEHOLD
    households:
      household:
        members: [person1, person2]
        state_code: NY
  output:
    ny_agi: 60_000

    # HOH standard deduction = $11,200
    ny_standard_deduction: 11_200

    # 1 child dependent * $1,000 = $1,000
    ny_exemptions: 1_000

    # Taxable income = $60,000 - $11,200 - $1,000 = $47,800
    ny_taxable_income: 47_800

    # Main tax (2025 HOH brackets):
    # $0-$12,800: $12,800 * 4% = $512
    # $12,800-$17,650: $4,850 * 4.5% = $218.25
    # $17,650-$20,900: $3,250 * 5.25% = $170.625
    # $20,900-$47,800: $26,900 * 5.5% = $1,479.50
    # Total = $512 + $218.25 + $170.625 + $1,479.50 = $2,380.375
    ny_main_income_tax: 2_380.375

    # AGI ($60,000) < $107,650, no supplemental tax
    ny_supplemental_tax: 0

- name: Case 5, Empire State CTC 2025 with children ages 2 and 8.
  # Family with young child (under 4) and older child (4-16)
  # Child age 2: $1,000 credit
  # Child age 8: $330 credit (ages 4-16 in 2025)
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        employment_income: 50_000
        is_tax_unit_head: true
      person2:
        age: 2
        is_tax_unit_dependent: true
      person3:
        age: 8
        is_tax_unit_dependent: true
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
        adjusted_gross_income: 50_000
        filing_status: SINGLE
    households:
      household:
        members: [person1, person2, person3]
        state_code: NY
  output:
    # Base credit: $1,000 (child under 4) + $330 (child 4-16) = $1,330
    ny_ctc_post_2024_base: 1_330

    # AGI ($50,000) < $75,000 threshold for single filer
    # No phase-out applies
    ny_ctc_post_2024_phase_out: 0

    # Total CTC = base - phase_out = $1,330 - $0 = $1,330
    ny_ctc_post_2024: 1_330

- name: Case 6, Empire State CTC 2025 with phase-out.
  # Family above income threshold for phase-out
  # Tests phase-out calculation
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        employment_income: 90_000
        is_tax_unit_head: true
      person2:
        age: 2
        is_tax_unit_dependent: true
    tax_units:
      tax_unit:
        members: [person1, person2]
        adjusted_gross_income: 90_000
        filing_status: SINGLE
    households:
      household:
        members: [person1, person2]
        state_code: NY
  output:
    # Base credit: $1,000 (child under 4)
    ny_ctc_post_2024_base: 1_000

    # AGI ($90,000) exceeds $75,000 threshold by $15,000
    # Phase-out: $16.50 per $1,000 = 15 * $16.50 = $247.50
    ny_ctc_post_2024_phase_out: 247.5

    # Total CTC = $1,000 - $247.50 = $752.50
    ny_ctc_post_2024: 752.5

- name: Case 7, geothermal credit 2025 under cap.
  # Test geothermal credit with annual period 2025
  # Annual period uses start-of-year cap of $5,000
  # $15,000 expenditures * 25% = $3,750 (under $5,000 cap)
  period: 2025
  input:
    people:
      person1:
        age: 45
    tax_units:
      tax_unit:
        members: [person1]
        ny_qualified_geothermal_energy_system_expenditures: 15_000
    households:
      household:
        members: [person1]
        state_code: NY
  output:
    # Credit = $15,000 * 25% = $3,750
    # Cap is $5,000 before July 1, 2025 and $10,000 after
    # Since this is annual period covering full year,
    # credit calculation uses applicable parameters
    ny_geothermal_energy_system_credit: 3_750

- name: Case 8, geothermal credit 2025 at cap.
  # Test geothermal credit with high expenditures hitting cap
  # $50,000 expenditures * 25% = $12,500 but capped
  period: 2025
  input:
    people:
      person1:
        age: 45
    tax_units:
      tax_unit:
        members: [person1]
        ny_qualified_geothermal_energy_system_expenditures: 50_000
    households:
      household:
        members: [person1]
        state_code: NY
  output:
    # Credit = min($50,000 * 25%, cap) = min($12,500, $5,000) = $5,000
    # Note: Annual period 2025 uses start-of-year cap ($5,000)
    # The $10,000 cap applies for systems placed in service on/after July 1, 2025
    ny_geothermal_energy_system_credit: 5_000

- name: Case 9, joint filer with high income CTC phase-out.
  # Joint filers have $110,000 threshold
  # Tests higher phase-out threshold for joint filers
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 35
        is_tax_unit_head: true
      person2:
        age: 33
        is_tax_unit_spouse: true
      person3:
        age: 3
        is_tax_unit_dependent: true
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
        adjusted_gross_income: 130_000
        filing_status: JOINT
    households:
      household:
        members: [person1, person2, person3]
        state_code: NY
  output:
    # Base credit: $1,000 (child under 4)
    ny_ctc_post_2024_base: 1_000

    # AGI ($130,000) exceeds joint threshold ($110,000) by $20,000
    # Phase-out: 20 * $16.50 = $330
    ny_ctc_post_2024_phase_out: 330

    # Total CTC = $1,000 - $330 = $670
    ny_ctc_post_2024: 670

- name: Case 10, low income single filer with no tax liability.
  # Income below standard deduction results in no tax
  period: 2025
  absolute_error_margin: 0.01
  input:
    people:
      person1:
        age: 25
        employment_income: 6_000
    tax_units:
      tax_unit:
        members: [person1]
        filing_status: SINGLE
    households:
      household:
        members: [person1]
        state_code: NY
  output:
    ny_agi: 6_000

    # Single standard deduction = $8,000
    ny_standard_deduction: 8_000

    # Taxable income = max(0, $6,000 - $8,000) = $0
    ny_taxable_income: 0

    # No taxable income = no tax
    ny_main_income_tax: 0
    ny_supplemental_tax: 0
    ny_income_tax_before_credits: 0
