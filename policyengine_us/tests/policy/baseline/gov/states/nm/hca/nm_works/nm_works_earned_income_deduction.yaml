# New Mexico Works (TANF) Earned Income Deduction Unit Tests
# Tests the work incentive deduction calculation
# Source: 8.102.520.12 NMAC - Earned Income Deductions
# Single parent: $125 flat + 50% of remainder
# Two-parent: $225 flat + 50% of remainder (per parent)
# Other member: $125 flat + 50% of remainder

- name: Case 1, single parent with no earnings has zero deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # No earnings = no deduction
    nm_works_earned_income_deduction_person: [0, 0]

- name: Case 2, single parent with earnings below flat deduction amount.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_200  # $100/month
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # Single parent flat deduction: $125
    # Gross earnings: $100
    # $100 < $125, so deduction = $100 (capped at earnings)
    nm_works_earned_income_deduction_person: [100, 0]

- name: Case 3, single parent with moderate earnings.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12_000  # $1,000/month
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # Single parent: $125 + 50% of remainder
    # Gross earnings: $1,000
    # Step 1: $1,000 - $125 = $875
    # Step 2: $875 * 0.50 = $437.50
    # Total deduction: $125 + $437.50 = $562.50
    nm_works_earned_income_deduction_person: [562.5, 0]

- name: Case 4, two-parent household with both working.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 9_600  # $800/month
        is_tax_unit_head: true
        is_parent: true
      person2:
        age: 33
        employment_income_before_lsr: 6_000  # $500/month
        is_tax_unit_spouse: true
        is_parent: true
      person3:
        age: 10
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: NM
  output:
    # Two-parent: $225 + 50% of remainder (each parent)
    #
    # Parent 1 ($800/month):
    # Step 1: $800 - $225 = $575
    # Step 2: $575 * 0.50 = $287.50
    # Total deduction: $225 + $287.50 = $512.50
    #
    # Parent 2 ($500/month):
    # Step 1: $500 - $225 = $275
    # Step 2: $275 * 0.50 = $137.50
    # Total deduction: $225 + $137.50 = $362.50
    nm_works_earned_income_deduction_person: [512.5, 362.5, 0]

- name: Case 5, two-parent household with one parent working.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 18_000  # $1,500/month
        is_tax_unit_head: true
        is_parent: true
      person2:
        age: 33
        employment_income_before_lsr: 0
        is_tax_unit_spouse: true
        is_parent: true
      person3:
        age: 7
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: NM
  output:
    # Two-parent: $225 + 50% of remainder
    # Parent 1 ($1,500/month):
    # Step 1: $1,500 - $225 = $1,275
    # Step 2: $1,275 * 0.50 = $637.50
    # Total deduction: $225 + $637.50 = $862.50
    # Parent 2: $0 earnings = $0 deduction
    nm_works_earned_income_deduction_person: [862.5, 0, 0]

- name: Case 6, two-parent household with earnings below flat deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 2_400  # $200/month
        is_tax_unit_head: true
        is_parent: true
      person2:
        age: 33
        employment_income_before_lsr: 1_200  # $100/month
        is_tax_unit_spouse: true
        is_parent: true
      person3:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: NM
  output:
    # Two-parent flat deduction: $225 each
    # Parent 1: $200 < $225, so deduction = $200
    # Parent 2: $100 < $225, so deduction = $100
    nm_works_earned_income_deduction_person: [200, 100, 0]

# Edge Cases: Flat deduction boundaries and special scenarios

- name: Case 7, single parent earnings exactly at flat deduction amount.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_500  # $125/month = exactly flat deduction
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # Single parent flat: $125
    # Gross: $125 = exactly flat amount
    # After flat: $125 - $125 = $0
    # No percentage deduction applies (nothing left)
    # Total deduction: $125
    nm_works_earned_income_deduction_person: [125, 0]

- name: Case 8, single parent earnings one dollar above flat deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_512  # $126/month
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # Single parent flat: $125
    # Gross: $126
    # After flat: $126 - $125 = $1
    # Percentage: $1 * 0.50 = $0.50
    # Total deduction: $125 + $0.50 = $125.50
    nm_works_earned_income_deduction_person: [125.5, 0]

- name: Case 9, two-parent earnings exactly at flat deduction amount.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 2_700  # $225/month = exactly flat deduction
        is_tax_unit_head: true
        is_parent: true
      person2:
        age: 33
        employment_income_before_lsr: 2_700  # $225/month = exactly flat deduction
        is_tax_unit_spouse: true
        is_parent: true
      person3:
        age: 8
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: NM
  output:
    # Two-parent flat: $225 each
    # Both parents: $225 = exactly flat amount
    # After flat: $0 for each
    # Total deduction: $225 each
    nm_works_earned_income_deduction_person: [225, 225, 0]

- name: Case 10, two-parent earnings one dollar above flat deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 2_712  # $226/month
        is_tax_unit_head: true
        is_parent: true
      person2:
        age: 33
        employment_income_before_lsr: 0
        is_tax_unit_spouse: true
        is_parent: true
      person3:
        age: 6
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
    tax_units:
      tax_unit:
        members: [person1, person2, person3]
    households:
      household:
        members: [person1, person2, person3]
        state_code: NM
  output:
    # Two-parent flat: $225
    # Gross: $226
    # After flat: $226 - $225 = $1
    # Percentage: $1 * 0.50 = $0.50
    # Total deduction: $225 + $0.50 = $225.50
    nm_works_earned_income_deduction_person: [225.5, 0, 0]

- name: Case 11, very high earnings results in large deduction.
  period: 2024-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 60_000  # $5,000/month
        is_parent: true
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: NM
  output:
    # Single parent: $125 + 50% of remainder
    # Gross: $5,000
    # After flat: $5,000 - $125 = $4,875
    # Percentage: $4,875 * 0.50 = $2,437.50
    # Total deduction: $125 + $2,437.50 = $2,562.50
    nm_works_earned_income_deduction_person: [2_562.5, 0]
