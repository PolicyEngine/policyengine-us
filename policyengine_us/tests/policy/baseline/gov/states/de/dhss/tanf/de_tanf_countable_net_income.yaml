# Unit tests for Delaware TANF countable net income
# 16 Del. Admin. Code SS 4000-4008: Net income after deductions
# https://www.law.cornell.edu/regulations/delaware/16-Del-Admin-Code-SS-4000-4008
# Calculation order:
# 1. Subtract $90 work expense from each earner's earned income
# 2. Subtract dependent care expenses (up to limits)
# 3. Subtract $50 child support disregard from unearned income
# 4. Result = countable net income
# Note: Negative earned and unearned income are capped at 0

- name: Earned income with work expense deduction
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12_000  # $1,000/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly earned: $1,000
    # Work expense: $90
    # Net earned: $1,000 - $90 = $910
    # No unearned income
    # Countable net: $910
    de_tanf_countable_net_income: 910

- name: Unearned income with child support disregard
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 2_400  # $200/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly unearned (child support): $200
    # Child support disregard: $50
    # Countable unearned: $200 - $50 = $150
    # No earned income
    # Countable net: $150
    de_tanf_countable_net_income: 150

- name: Combined income with all deductions
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12_000  # $1,000/month
        child_support_received: 1_200  # $100/month
      person2:
        age: 1
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        childcare_expenses: 2_400  # $200/month annual
    households:
      household:
        members: [person1, person2]
        state_code: DE
  output:
    # Monthly earned: $1,000
    # Work expense: $90
    # After work expense: $910
    # Dependent care deduction: $200 (child under 2, max $200)
    # Net earned: $910 - $200 = $710
    # Monthly child support: $100
    # Child support disregard: $50
    # Net unearned: $100 - $50 = $50
    # Countable net: $710 + $50 = $760
    de_tanf_countable_net_income: 760

- name: Two earners with deductions
  period: 2025-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 18_000  # $1,500/month
      person2:
        age: 33
        employment_income_before_lsr: 9_600  # $800/month
      person3:
        age: 3
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2, person3]
        childcare_expenses: 3_000  # $250/month annual
    households:
      household:
        members: [person1, person2, person3]
        state_code: DE
  output:
    # Monthly earned: $1,500 + $800 = $2,300
    # Work expense: $90 * 2 earners = $180
    # After work expense: $2,300 - $180 = $2,120
    # Dependent care: min($250, $175) = $175 (child age 2+)
    # Net earned: $2,120 - $175 = $1,945
    # Countable net: $1,945
    de_tanf_countable_net_income: 1_945

- name: No income - zero countable net
  period: 2025-01
  input:
    people:
      person1:
        age: 30
      person2:
        age: 5
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: DE
  output:
    de_tanf_countable_net_income: 0

# ============================================================================
# EDGE CASE TESTS: Earned Income Deduction Capping
# ============================================================================

- name: Edge case - earnings exactly at $90 (deduction = earnings)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_080  # $90/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly earned: $90
    # Work expense deduction: $90
    # Net earned: max($90 - $90, 0) = $0
    de_tanf_countable_net_income: 0

- name: Edge case - earnings below $90 (deduction capped at zero net)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 600  # $50/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly earned: $50
    # Work expense deduction: $90 (but capped to prevent negative)
    # Net earned: max($50 - $90, 0) = $0
    de_tanf_countable_net_income: 0

- name: Edge case - earnings $1 above $90
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_092  # $91/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly earned: $91
    # Work expense deduction: $90
    # Net earned: max($91 - $90, 0) = $1
    de_tanf_countable_net_income: 1

- name: Edge case - minimal earnings ($1)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12  # $1/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Monthly earned: $1
    # Work expense deduction: $90
    # Net earned: max($1 - $90, 0) = $0
    de_tanf_countable_net_income: 0

# ============================================================================
# EDGE CASE TESTS: Unearned Only Income
# ============================================================================

- name: Edge case - unearned income only (no earned income)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 1_200  # $100/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # No earned income, no work expense deduction
    # Child support: $100
    # Disregard: $50
    # Net unearned: $100 - $50 = $50
    de_tanf_countable_net_income: 50

- name: Edge case - child support exactly at $50 disregard
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 600  # $50/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Child support: $50
    # Disregard: min($50, $50) = $50
    # Net unearned: max($50 - $50, 0) = $0
    de_tanf_countable_net_income: 0

- name: Edge case - child support below $50 disregard
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        child_support_received: 360  # $30/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Child support: $30
    # Disregard: min($30, $50) = $30
    # Net unearned: max($30 - $30, 0) = $0
    de_tanf_countable_net_income: 0

# ============================================================================
# EDGE CASE TESTS: Zero Values
# ============================================================================

- name: Edge case - zero earned income with unearned income
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 0
        child_support_received: 3_600  # $300/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Earned: $0, no work expense applies
    # Child support: $300
    # Disregard: $50
    # Net unearned: $300 - $50 = $250
    de_tanf_countable_net_income: 250

- name: Edge case - earned income only (no unearned income)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 12_000  # $1,000/month
        child_support_received: 0
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Earned: $1,000
    # Work expense: $90
    # Net earned: $1,000 - $90 = $910
    # No unearned income
    de_tanf_countable_net_income: 910

# ============================================================================
# EDGE CASE TESTS: Combined Deductions Capping
# ============================================================================

- name: Edge case - work expense + dependent care exceeds earned (capped at zero)
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 1_200  # $100/month
      person2:
        age: 1
        is_tax_unit_dependent: true
    spm_units:
      spm_unit:
        members: [person1, person2]
        childcare_expenses: 2_400  # $200/month (equals max for under 2)
    households:
      household:
        members: [person1, person2]
        state_code: DE
  output:
    # Earned: $100
    # Work expense: $90
    # After work expense: $100 - $90 = $10
    # Dependent care: min($200, $200) = $200
    # Net earned: max($10 - $200, 0) = $0 (capped)
    de_tanf_countable_net_income: 0

- name: Edge case - work expense exceeds earned with unearned income
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 600  # $50/month
        child_support_received: 1_200  # $100/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Earned: $50
    # Work expense: $90
    # Net earned: max($50 - $90, 0) = $0 (capped)
    # Child support: $100
    # Disregard: $50
    # Net unearned: $100 - $50 = $50
    # Countable net: $0 + $50 = $50
    de_tanf_countable_net_income: 50

# ============================================================================
# EDGE CASE TESTS: Multiple Earners with Low Income
# ============================================================================

- name: Edge case - two earners each below $90
  period: 2025-01
  input:
    people:
      person1:
        age: 35
        employment_income_before_lsr: 600  # $50/month
      person2:
        age: 33
        employment_income_before_lsr: 480  # $40/month
    spm_units:
      spm_unit:
        members: [person1, person2]
    households:
      household:
        members: [person1, person2]
        state_code: DE
  output:
    # Total earned: $50 + $40 = $90
    # Work expense: $90 * 2 = $180
    # Net earned: max($90 - $180, 0) = $0
    de_tanf_countable_net_income: 0

# ============================================================================
# EDGE CASE TESTS: High Combined Income
# ============================================================================

- name: Edge case - high earned and unearned income
  period: 2025-01
  input:
    people:
      person1:
        age: 30
        employment_income_before_lsr: 36_000  # $3,000/month
        child_support_received: 3_600  # $300/month
    spm_units:
      spm_unit:
        members: [person1]
    households:
      household:
        members: [person1]
        state_code: DE
  output:
    # Earned: $3,000
    # Work expense: $90
    # Net earned: $3,000 - $90 = $2,910
    # Child support: $300
    # Disregard: $50
    # Net unearned: $300 - $50 = $250
    # Countable net: $2,910 + $250 = $3,160
    de_tanf_countable_net_income: 3_160
